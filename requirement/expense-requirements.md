# 支出管理模块 - 需求文档

## 1. 概述

支出管理模块是家庭财务管理系统的核心模块之一，用于记录、分类、分析和预算家庭的日常和大额支出。

### 1.1 设计理念

- **月度汇总记录**：采用月度汇总方式，而非每日流水账，减少记录工作量
- **分层分类**：采用大类+子分类两层结构，平衡灵活性和管理成本
- **预算管控**：支持按子分类设置年度预算，实时监控执行情况
- **多货币支持**：支持多种货币记录，自动转换为基准货币统计
- **支出类型**：区分固定日常支出和不定期大额支出，便于分析

## 2. 功能需求

### 2.1 分类管理

#### 2.1.1 大类管理

**固定大类（9个）**：
1. 子女 (CHILDREN)
2. 衣 (CLOTHING)
3. 食 (FOOD)
4. 住 (HOUSING)
5. 行 (TRANSPORTATION)
6. 保险 (INSURANCE)
7. 人情 (SOCIAL)
8. 娱乐 (ENTERTAINMENT)
9. 经营 (BUSINESS)

**大类属性**：
- 编码（英文代码，唯一）
- 名称（中文名称）
- 图标（emoji 或图标类名）
- 颜色代码（用于界面展示）
- 排序顺序
- 启用状态

**功能**：
- 查询所有大类列表
- 大类只能停用/启用，不能删除或新增

#### 2.1.2 子分类管理

**子分类属性**：
- 所属大类
- 名称（自定义）
- 支出类型（固定日常 FIXED_DAILY / 不定期大额 LARGE_IRREGULAR）
- 是否系统默认
- 排序顺序
- 启用状态
- 说明

**功能**：
- 查询所有分类（大类+子分类树形结构）
- 新增子分类
- 编辑子分类（名称、排序、类型、说明）
- 停用/删除子分类
  - 有关联记录：只能停用
  - 无关联记录：可以删除

**UI设计**：
- 列表展示：大类折叠面板 + 子分类卡片列表
- 每个子分类卡片显示：
  - 大类图标 + 子分类名称
  - 支出类型标签（固定/不定期）
  - 关联记录数量
  - 编辑/停用按钮

### 2.2 支出记录管理

#### 2.2.1 批量录入

**录入方式**：按月份批量录入，一次性完成当月所有分类的支出记录

**选择器**：
- 家庭选择
- 货币选择（CNY/USD/EUR等）
- 月份选择（YYYY-MM格式）

**录入界面**：
- 表格形式展示所有子分类
- 每行包含：
  - 大类图标 + 子分类名称
  - 支出类型标签
  - 前3个月历史数据（只读，辅助参考）
  - 当月金额输入框

**历史数据展示**：
- 显示前3个月同分类的支出金额
- 帮助用户参考历史趋势
- 固定日常支出通常较为稳定

**顶部统计**：
- 前3个月总支出（总额 + 固定日常金额）
- 本月总支出
- 本月固定日常支出（金额 + 占比）
- 本月不定期支出（金额 + 占比）

**排序规则**：
1. 优先按支出类型：固定日常在前，不定期在后
2. 同类型内：有历史数据的排在前面
3. 最后按分类ID排序

**保存逻辑**：
- 同一期间+同一分类+同一货币，只能有一条记录
- 新录入：创建新记录
- 已存在：更新金额
- 金额为0：删除记录

**UI设计**：
```
┌─────────────────────────────────────────────────┐
│ 家庭: [选择器] 货币: [选择器] 月份: [选择器]    [保存全部] │
├─────────────────────────────────────────────────┤
│ 统计：                                          │
│ 11月总支出: $5.2K (固定 $3.8K)                  │
│ 12月总支出: $5.5K (固定 $4.0K)                  │
│ 01月总支出: $5.8K (固定 $4.2K)                  │
│ 本月总支出: $6.0K | 固定: $4.5K (75%) | 不定期: $1.5K (25%) │
├─────────────────────────────────────────────────┤
│ 分类          │  11月  │  12月  │  01月  │ 02月       │
├─────────────────────────────────────────────────┤
│ 🍔 食 - 早餐   │  200   │  220   │  210   │ [$___]     │
│ [固定]        │        │        │        │            │
│ 🍔 食 - 午餐   │  300   │  280   │  320   │ [$___]     │
│ ...                                            │
└─────────────────────────────────────────────────┘
```

#### 2.2.2 记录查询

**查询方式**：
- 按期间查询：单个月份
- 按期间范围查询：起止期间

**返回数据**：
- 支出记录列表
- 包含大类、子分类名称、图标
- 金额、货币、支出类型
- 说明、创建/更新时间

### 2.3 预算管理

#### 2.3.1 预算设置

**预算粒度**：
- 按子分类设置年度预算
- 每个子分类可设置多种货币的预算

**批量设置界面**：
- 选择：家庭 + 年份 + 货币
- 表格展示所有子分类
- 每行包含：
  - 大类图标 + 子分类名称
  - 支出类型
  - 前一年实际金额（参考）
  - 当年预算输入框

**保存逻辑**：
- 同一家庭+同一年份+同一子分类+同一货币，只能有一条预算
- 新录入：创建预算
- 已存在：更新金额
- 金额为0：删除预算

**UI设计**：
```
┌─────────────────────────────────────────────────┐
│ 家庭: [选择器] 年份: [2025] 货币: [USD]  [保存全部] │
├─────────────────────────────────────────────────┤
│ 分类          │ 2024实际 │ 2025预算 │ 说明         │
├─────────────────────────────────────────────────┤
│ 🍔 食 - 早餐   │  2,400   │ [$___]   │ [______]     │
│ [固定]        │          │          │              │
│ 🍔 食 - 午餐   │  3,600   │ [$___]   │ [______]     │
│ ...                                              │
└─────────────────────────────────────────────────┘
```

#### 2.3.2 预算执行分析

**查询条件**：
- 家庭 + 年份 + 货币（支持All模式）

**分析维度**：
- 按子分类统计
- 显示：预算金额 vs 实际金额
- 计算：差异金额、执行率

**显示内容**：
- 有预算的分类：显示预算、实际、差异、执行率
- 无预算但有支出的分类：显示实际金额，预算为0

**UI设计**：
```
┌─────────────────────────────────────────────────┐
│ 2025年度预算执行情况 - USD                       │
├─────────────────────────────────────────────────┤
│ 分类          │ 预算   │ 实际   │ 差异   │ 执行率 │
├─────────────────────────────────────────────────┤
│ 🍔 食 - 早餐   │ 2,400  │ 2,200  │ +200   │ 92%    │
│ 🍔 食 - 午餐   │ 3,600  │ 4,000  │ -400   │ 111%   │
│ ...                                            │
└─────────────────────────────────────────────────┘
```

### 2.4 年度分析

#### 2.4.1 年度大类汇总

**查询条件**：
- 家庭 + 年份 + 货币（支持All模式转USD）

**统计维度**：
- 按大类汇总年度支出
- All模式：自动转换为USD统一统计

**显示方式**：
- 饼图/柱状图展示大类占比
- 表格详细列表
- 按金额降序排列

**UI设计**：
```
┌─────────────────────────────────────────────────┐
│ 2025年度大类支出分析 - All (USD)                 │
├─────────────────────────────────────────────────┤
│           [饼图展示各大类占比]                    │
├─────────────────────────────────────────────────┤
│ 大类       │ 金额     │ 占比                     │
├─────────────────────────────────────────────────┤
│ 🍔 食      │ $12,000  │ ████████████ 30%         │
│ 🏠 住      │ $10,000  │ ██████████ 25%           │
│ ...                                             │
└─────────────────────────────────────────────────┘
```

#### 2.4.2 年度小类明细

**查询条件**：
- 家庭 + 年份 + 大类 + 货币

**统计维度**：
- 按小类汇总某大类下的年度支出
- 显示支出类型、金额

**UI设计**：
```
┌─────────────────────────────────────────────────┐
│ 2025年度 - 食 - 小类明细 (USD)                   │
├─────────────────────────────────────────────────┤
│ 子分类     │ 类型     │ 金额     │ 占比         │
├─────────────────────────────────────────────────┤
│ 早餐       │ 固定     │ $2,400   │ ████ 20%     │
│ 午餐       │ 固定     │ $3,600   │ ██████ 30%   │
│ 晚餐       │ 固定     │ $3,000   │ █████ 25%    │
│ 聚餐       │ 不定期   │ $3,000   │ █████ 25%    │
└─────────────────────────────────────────────────┘
```

#### 2.4.3 月度趋势

**查询条件**：
- 家庭 + 年份 + 子分类 + 货币

**显示内容**：
- 某个子分类的12个月支出趋势
- 折线图展示

**用途**：
- 识别支出规律
- 发现异常波动

**UI设计**：
```
┌─────────────────────────────────────────────────┐
│ 2025年度 - 早餐 - 月度趋势 (USD)                 │
├─────────────────────────────────────────────────┤
│           [折线图：12个月的支出金额]              │
├─────────────────────────────────────────────────┤
│ 月份 │ 01   │ 02   │ 03   │ ... │ 12            │
│ 金额 │ 200  │ 210  │ 205  │ ... │ 220           │
└─────────────────────────────────────────────────┘
```

#### 2.4.4 年度汇总（含资产调整）

**说明**：某些支出实际上增加了资产价值，需要调整后才能得到真实的消费支出

**调整逻辑**：
1. **资产类调整**：
   - 房产装修、车辆保养等 → 资产增值
   - 实际支出 = 支出金额 - 资产增值

2. **负债类调整**：
   - 房贷本金还款 → 减少负债（不算支出）
   - 房贷利息 → 真实支出
   - 实际支出 = 支出金额 - 本金还款

**查询条件**：
- 家庭 + 年份 + 货币 + 是否显示总计

**显示内容**：
- 按大类汇总
- 每行显示：
  - 基础支出金额
  - 资产调整金额
  - 负债调整金额
  - 实际支出金额
  - 调整明细（JSON格式）

**数据来源**：
- 预计算的`annual_expense_summary`表
- 通过存储过程定期更新

## 3. 数据模型

### 3.1 支出大类表 (expense_categories_major)

```sql
id                  BIGINT          -- 主键ID
code                VARCHAR(50)     -- 大类编码（CHILDREN, CLOTHING等）
name                VARCHAR(50)     -- 大类名称
icon                VARCHAR(50)     -- 图标
color               VARCHAR(20)     -- 颜色代码
sort_order          INT             -- 排序顺序
is_active           BOOLEAN         -- 是否启用
description         TEXT            -- 说明
created_at          TIMESTAMP       -- 创建时间
updated_at          TIMESTAMP       -- 更新时间
```

### 3.2 支出子分类表 (expense_categories_minor)

```sql
id                  BIGINT          -- 主键ID
major_category_id   BIGINT          -- 所属大类ID
name                VARCHAR(100)    -- 子分类名称
expense_type        VARCHAR(20)     -- 支出类型（FIXED_DAILY/LARGE_IRREGULAR）
is_active           BOOLEAN         -- 是否启用
is_default          BOOLEAN         -- 是否系统默认分类
sort_order          INT             -- 排序顺序
description         TEXT            -- 说明
created_at          TIMESTAMP       -- 创建时间
updated_at          TIMESTAMP       -- 更新时间

UNIQUE (major_category_id, name)    -- 同一大类下子分类名称唯一
```

### 3.3 支出记录表 (expense_records)

```sql
id                      BIGINT          -- 主键ID
family_id               BIGINT          -- 家庭ID
user_id                 BIGINT          -- 记录人ID
expense_year            INT             -- 支出年份
expense_month           INT             -- 支出月份
expense_period          VARCHAR(7)      -- 支出期间（YYYY-MM）
major_category_id       BIGINT          -- 大类ID
minor_category_id       BIGINT          -- 子分类ID
amount                  DECIMAL(18,2)   -- 支出金额
currency                VARCHAR(10)     -- 货币代码
expense_type            VARCHAR(20)     -- 支出类型
description             TEXT            -- 说明
created_at              TIMESTAMP       -- 创建时间
updated_at              TIMESTAMP       -- 更新时间

UNIQUE (family_id, expense_period, minor_category_id, currency)
-- 同一期间同一分类同一货币只有一条记录
```

### 3.4 支出预算表 (expense_budgets)

```sql
id                  BIGINT          -- 主键ID
family_id           BIGINT          -- 家庭ID
budget_year         INT             -- 预算年份
minor_category_id   BIGINT          -- 子分类ID
budget_amount       DECIMAL(15,2)   -- 预算金额
currency            VARCHAR(10)     -- 货币类型
notes               VARCHAR(500)    -- 备注说明
created_at          TIMESTAMP       -- 创建时间
updated_at          TIMESTAMP       -- 更新时间

UNIQUE (family_id, budget_year, minor_category_id, currency)
-- 每个家庭每年每个子分类每种货币只能有一条预算记录
```

### 3.5 年度支出汇总表 (annual_expense_summary)

```sql
id                      BIGINT          -- 主键ID
family_id               BIGINT          -- 家庭ID
summary_year            INT             -- 汇总年份
major_category_id       BIGINT          -- 大类ID（0表示总计）
minor_category_id       BIGINT          -- 子分类ID（NULL表示大类汇总）
base_expense_amount     DECIMAL(18,2)   -- 基础支出金额
asset_adjustment        DECIMAL(18,2)   -- 资产调整金额
liability_adjustment    DECIMAL(18,2)   -- 负债调整金额
actual_expense_amount   DECIMAL(18,2)   -- 实际支出金额
currency                VARCHAR(10)     -- 货币类型
adjustment_details      JSON            -- 调整明细
created_at              TIMESTAMP       -- 创建时间
updated_at              TIMESTAMP       -- 更新时间
```

## 4. 业务规则

### 4.1 货币转换

- **基准货币**：CNY（人民币）
- **中间货币**：USD（美元）
- **固定汇率**：1 USD = 7 CNY
- **其他货币**：先查询汇率表转USD，再转CNY

### 4.2 支出类型

- **固定日常 (FIXED_DAILY)**：
  - 每月相对稳定的支出
  - 如：早餐、午餐、晚餐、房租、水电费等

- **不定期大额 (LARGE_IRREGULAR)**：
  - 不定期发生的大额支出
  - 如：聚餐、旅游、电子产品、大型家电等

### 4.3 数据完整性

- 大类不能删除，只能停用
- 子分类有关联记录时不能删除，只能停用
- 支出记录删除时不影响分类
- 预算可以随时调整或删除

## 5. 权限要求

### 5.1 家庭成员权限

- 查看本家庭的所有支出记录
- 创建、修改本家庭的支出记录
- 设置和修改本家庭的预算
- 查看所有分析报表

### 5.2 管理员权限

- 管理大类（启用/停用）
- 管理所有家庭的数据
- 执行系统维护任务

## 6. 性能要求

### 6.1 响应时间

- 列表查询：< 500ms
- 批量保存：< 2s
- 年度分析：< 3s
- 报表生成：< 5s

### 6.2 并发处理

- 支持多用户同时录入
- 同一记录的并发更新：后提交覆盖

## 7. 用户界面要求

### 7.1 响应式设计

- 支持桌面端（1920x1080以上）
- 支持移动端（375px以上）
- 自适应布局，优化触摸操作

### 7.2 交互体验

- 表格内输入框自动聚焦
- 支持Tab键快速切换
- 自动保存草稿（可选）
- 实时计算统计数据
- 友好的错误提示

### 7.3 数据可视化

- 饼图：大类占比
- 柱状图：大类对比
- 折线图：月度趋势
- 进度条：预算执行率

## 8. 数据导入导出

### 8.1 导入

- 支持Excel格式导入历史数据
- 自动匹配分类
- 重复数据处理策略

### 8.2 导出

- 支持导出Excel格式
- 导出PDF报表
- 自定义导出字段

## 9. 未来扩展

### 9.1 智能分析

- 支出趋势预测
- 异常支出提醒
- 预算超支预警

### 9.2 多维度分析

- 按成员分析
- 按地区分析
- 同期对比分析

### 9.3 第三方集成

- 银行账单导入
- 信用卡账单导入
- 电子发票识别
