# 支出管理系统 - 详细需求文档

> 文档创建时间：2025-12-10
> 需求类型：P0 - 核心功能
> 预计工作量：2-3周

---

## 📋 需求概述

### 背景
当前系统只能追踪资产余额变化，无法了解支出去向和消费结构。支出管理是财务管理的核心基础功能，需要尽快补充。

### 设计理念
**简化优于完美**：
- 不追求记录每笔交易明细（太繁琐，难以坚持）
- 采用**月度汇总**方式，平衡易用性和数据价值
- 支持固定支出和大额支出区分，便于预算控制
- 分类体系固定大类，灵活子分类

### 核心价值
- ✅ 了解钱花在哪里
- ✅ 发现支出结构问题
- ✅ 为预算管理提供基础数据
- ✅ 计算储蓄率等关键指标

---

## 🎯 功能需求

### 一、支出分类管理

#### 1.1 分类层级结构

**两级分类体系**：大类（固定）→ 子分类（可自定义）

##### 大类（固定9个）

| 大类编码 | 大类名称 | 英文标识 | 图标 | 颜色 | 说明 |
|---------|---------|----------|------|------|------|
| 1 | 子女 | CHILDREN | 👶 | #FF6B6B | 子女教育、生活、医疗等 |
| 2 | 衣 | CLOTHING | 👔 | #4ECDC4 | 服装、鞋帽、配饰 |
| 3 | 食 | FOOD | 🍜 | #95E1D3 | 餐饮、食材、零食 |
| 4 | 住 | HOUSING | 🏠 | #F38181 | 房租、房贷、物业、维修、水电气 |
| 5 | 行 | TRANSPORTATION | 🚗 | #AA96DA | 交通、车辆、出行 |
| 6 | 保险 | INSURANCE | 🛡️ | #FCBAD3 | 各类保险费用 |
| 7 | 人情 | SOCIAL | 🎁 | #FFFFD2 | 礼金、请客、送礼 |
| 8 | 娱乐 | ENTERTAINMENT | 🎮 | #A8D8EA | 旅游、购物、娱乐、爱好 |
| 9 | 经营 | BUSINESS | 💼 | #FFB6B9 | 经营成本、投资支出 |
| 10 | 其他 | OTHER | 📦 | #C7CEEA | 未分类支出 |

**设计说明**：
- 大类不可删除、不可重命名（保证数据一致性）
- 大类顺序固定（按重要性和使用频率排序）
- 大类可以disable（停用但不删除历史数据）
- 每个大类有默认图标和颜色（便于视觉识别）

##### 子分类（可自定义）

**内置默认子分类**（系统初始化时自动创建）：

```
子女
  ├─ 学费
  ├─ 补习班
  ├─ 玩具书籍
  └─ 其他

衣
  ├─ 服装
  ├─ 鞋帽
  ├─ 配饰
  └─ 其他

食
  ├─ 外出就餐
  ├─ 食材采购
  ├─ 零食饮料
  └─ 其他

住
  ├─ 房租/房贷
  ├─ 物业费
  ├─ 水电气费
  ├─ 网络电话费
  ├─ 维修装修
  └─ 其他

行
  ├─ 公共交通
  ├─ 打车
  ├─ 加油
  ├─ 停车费
  ├─ 车辆维护
  ├─ 车辆保险
  └─ 其他

保险
  ├─ 医疗保险
  ├─ 人寿保险
  ├─ 意外险
  ├─ 财产险
  └─ 其他

人情
  ├─ 礼金
  ├─ 请客
  ├─ 送礼
  └─ 其他

娱乐
  ├─ 旅游
  ├─ 购物
  ├─ 电影/演出
  ├─ 运动健身
  ├─ 爱好兴趣
  └─ 其他

经营
  ├─ 办公成本
  ├─ 营销费用
  ├─ 人员工资
  ├─ 投资支出
  └─ 其他

其他
  └─ 未分类
```

**子分类操作**：
- ✅ 添加新子分类
- ✅ 修改子分类名称
- ✅ 停用子分类（disable，不删除）
- ✅ 启用已停用子分类
- ❌ 删除子分类（如果已有支出记录）
- ✅ 删除子分类（如果没有支出记录）

#### 1.2 分类管理界面

**页面路径**：支出管理 → 分类与记录

**布局设计**（参考AccountHistory.vue）：

```vue
<template>
  <div class="p-6 space-y-6">
    <!-- 页面标题 -->
    <div>
      <h1 class="text-2xl font-bold text-gray-900">支出分类与记录</h1>
      <p class="text-sm text-gray-600 mt-1">管理支出分类，查看月度支出趋势和记录</p>
    </div>

    <!-- 大类 Tab（固定9个） -->
    <div class="border-b border-gray-200">
      <nav class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Tabs">
        <button
          v-for="major in majorCategories"
          :key="major.id"
          @click="selectedMajorCategory = major"
          :class="[
            'whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm transition-colors flex items-center gap-2',
            selectedMajorCategory?.id === major.id
              ? 'border-primary text-primary'
              : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
          ]"
        >
          <span>{{ major.icon }}</span>
          <span>{{ major.name }}</span>
        </button>
      </nav>
    </div>

    <!-- 三列布局：子分类列表 + 趋势图 + 历史记录 -->
    <div class="grid grid-cols-12 gap-6">
      <!-- 左侧：子分类列表 -->
      <div class="col-span-12 lg:col-span-3">
        <div class="bg-white rounded-lg shadow border border-gray-200">
          <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-900">子分类</h2>
            <button
              @click="openCategoryDialog()"
              class="text-primary hover:text-primary/80 text-xs font-medium flex items-center gap-1"
            >
              <svg class="w-4 h-4">...</svg>
              添加分类
            </button>
          </div>

          <div v-if="loadingCategories" class="p-4 text-center text-gray-500 text-sm">
            加载中...
          </div>

          <div v-else-if="currentMinorCategories.length === 0" class="p-4 text-center text-gray-500 text-sm">
            该大类下暂无子分类
          </div>

          <div v-else>
            <div class="divide-y divide-gray-200 max-h-[calc(100vh-400px)] overflow-y-auto">
              <div
                v-for="category in currentMinorCategories"
                :key="category.id"
                :class="[
                  'group relative',
                  selectedMinorCategory?.id === category.id
                    ? 'bg-primary/10 border-l-4 border-primary'
                    : 'hover:bg-gray-50 border-l-4 border-transparent'
                ]"
              >
                <button
                  @click="selectCategory(category)"
                  class="w-full px-3 py-2 text-left transition-colors"
                >
                  <div class="flex items-center justify-between gap-2">
                    <div class="flex-1 min-w-0">
                      <div class="font-medium text-gray-900 text-sm truncate flex items-center gap-1">
                        {{ category.name }}
                        <span v-if="!category.isActive" class="text-xs text-gray-400 bg-gray-100 px-1 py-0.5 rounded">停用</span>
                      </div>
                      <div class="text-xs text-gray-500 mt-0.5">
                        {{ category.recordCount || 0 }} 条记录
                      </div>
                    </div>
                    <div v-if="category.latestAmount !== null" class="text-xs font-medium text-primary">
                      ¥{{ formatNumber(category.latestAmount) }}
                    </div>
                  </div>
                </button>

                <!-- 操作按钮 -->
                <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                  <button
                    @click.stop="openCategoryDialog(category)"
                    class="p-1 text-blue-600 hover:bg-blue-50 rounded"
                    title="编辑"
                  >
                    <svg class="w-4 h-4">...</svg>
                  </button>
                  <button
                    v-if="category.isActive"
                    @click.stop="disableCategory(category)"
                    class="p-1 text-orange-600 hover:bg-orange-50 rounded"
                    title="停用"
                  >
                    <svg class="w-4 h-4">...</svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- 大类总和 -->
            <div class="px-4 py-3 border-t border-gray-200 bg-gray-50">
              <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700">{{ selectedMajorCategory.name }}总计</span>
                <span class="text-base font-bold text-primary">
                  ¥{{ formatNumber(majorCategoryTotal) }}
                </span>
              </div>
              <div class="text-xs text-gray-500 mt-1">
                共 {{ currentMinorCategories.length }} 个子分类
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 中间和右侧：趋势图 + 历史记录 -->
      <div v-if="selectedMinorCategory" class="col-span-12 lg:col-span-9">
        <!-- 分类信息栏 -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-4 mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                {{ selectedMajorCategory.icon }} {{ selectedMajorCategory.name }} - {{ selectedMinorCategory.name }}
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                月度支出趋势与记录
              </p>
            </div>
            <button
              @click="openRecordDialog()"
              class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm font-medium flex items-center gap-2"
            >
              <svg class="w-4 h-4">...</svg>
              添加记录
            </button>
          </div>
        </div>

        <!-- 两列：趋势图 + 历史记录 -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
          <!-- 趋势图 -->
          <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-base font-semibold text-gray-900">支出趋势</h3>
              <div class="flex gap-2">
                <button
                  v-for="range in timeRanges"
                  :key="range.value"
                  @click="selectedTimeRange = range.value"
                  :class="[
                    'px-2 py-1 text-xs rounded-md font-medium transition-colors',
                    selectedTimeRange === range.value
                      ? 'bg-primary text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  ]"
                >
                  {{ range.label }}
                </button>
              </div>
            </div>
            <div v-if="records.length > 0" class="h-80">
              <canvas ref="chartCanvas"></canvas>
            </div>
            <div v-else class="h-80 flex items-center justify-center text-gray-500 text-sm">
              暂无数据，请添加记录
            </div>
          </div>

          <!-- 历史记录 -->
          <div class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-4 py-3 border-b border-gray-200">
              <h3 class="text-base font-semibold text-gray-900">历史记录</h3>
            </div>

            <div v-if="loadingRecords" class="text-center py-8 text-gray-500 text-sm">
              加载中...
            </div>

            <div v-else-if="filteredRecords.length === 0" class="text-center py-8 text-gray-500 text-sm">
              暂无记录
            </div>

            <div v-else class="overflow-y-auto max-h-96">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">期间</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">金额</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">类型</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">操作</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr v-for="record in filteredRecords" :key="record.id" class="hover:bg-gray-50">
                    <td class="px-3 py-2 text-sm text-gray-900">{{ record.expensePeriod }}</td>
                    <td class="px-3 py-2 text-sm text-gray-900 text-right font-medium">
                      ¥{{ formatNumber(record.amount) }}
                    </td>
                    <td class="px-3 py-2 text-center">
                      <span :class="[
                        'text-xs px-2 py-0.5 rounded',
                        record.expenseType === 'FIXED_DAILY'
                          ? 'bg-blue-100 text-blue-700'
                          : 'bg-orange-100 text-orange-700'
                      ]">
                        {{ record.expenseType === 'FIXED_DAILY' ? '固定' : '大额' }}
                      </span>
                    </td>
                    <td class="px-3 py-2 text-sm text-right">
                      <div class="flex justify-end gap-2">
                        <button
                          @click="editRecord(record)"
                          class="text-blue-600 hover:text-blue-800 text-xs"
                        >
                          编辑
                        </button>
                        <button
                          @click="deleteRecord(record)"
                          class="text-red-600 hover:text-red-800 text-xs"
                        >
                          删除
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 未选择分类的提示 -->
      <div v-else class="col-span-12 lg:col-span-9">
        <div class="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
          <svg class="mx-auto h-12 w-12 text-gray-400">...</svg>
          <h3 class="mt-2 text-sm font-medium text-gray-900">请选择子分类</h3>
          <p class="mt-1 text-sm text-gray-500">从左侧列表中选择一个子分类以查看其支出记录</p>
        </div>
      </div>
    </div>
  </div>
</template>
```

**界面特点**：

##### 1.2.1 布局结构（参考AccountHistory.vue）
- ✅ **顶部Tab导航**：9个固定大类（子女、衣、食、住、行、保险、人情、娱乐、经营、其他）
- ✅ **左侧子分类列表**：
  - 显示当前大类下的所有子分类
  - 选中状态高亮（bg-primary/10 + border-l-4）
  - 悬停显示操作按钮（编辑、停用）
  - 底部显示大类总计
- ✅ **右侧内容区**（选中子分类后）：
  - 上方：分类信息栏 + "添加记录"按钮
  - 左侧：月度支出趋势图（Chart.js）
  - 右侧：历史记录列表（期间、金额、类型、操作）

##### 1.2.2 子分类列表交互
- 点击切换选中状态
- 悬停显示操作按钮（opacity-0 → opacity-100）
- 显示记录数量和最近金额
- 停用的分类显示"停用"标签

##### 1.2.3 添加/编辑子分类对话框
```vue
<!-- 添加/编辑子分类对话框 -->
<div v-if="showCategoryDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">
      {{ editingCategory ? '编辑子分类' : '添加子分类' }}
    </h2>
    <form @submit.prevent="submitCategoryForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">所属大类</label>
        <div class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-900">
          {{ selectedMajorCategory.icon }} {{ selectedMajorCategory.name }}
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">子分类名称 *</label>
        <input
          v-model="categoryFormData.name"
          type="text"
          required
          placeholder="例如：学费"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
        />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">说明</label>
        <textarea
          v-model="categoryFormData.description"
          rows="3"
          placeholder="选填"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
        ></textarea>
      </div>

      <div v-if="editingCategory">
        <label class="flex items-center gap-2">
          <input
            v-model="categoryFormData.isActive"
            type="checkbox"
            class="w-4 h-4 text-primary"
          />
          <span class="text-sm text-gray-700">启用该分类</span>
        </label>
        <p v-if="editingCategory.recordCount > 0" class="text-xs text-amber-600 mt-1">
          ⚠️ 该分类已有 {{ editingCategory.recordCount }} 条支出记录
        </p>
      </div>

      <div class="flex gap-3 pt-2">
        <button
          v-if="editingCategory && editingCategory.recordCount === 0"
          type="button"
          @click="deleteCategory"
          class="px-4 py-2 text-red-600 border border-red-600 rounded-lg hover:bg-red-50"
        >
          删除
        </button>
        <button
          type="button"
          @click="closeCategoryDialog"
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
        >
          取消
        </button>
        <button
          type="submit"
          class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90"
        >
          {{ editingCategory ? '保存' : '添加' }}
        </button>
      </div>
    </form>
  </div>
</div>
```

**业务规则**：
1. 每个大类下必须至少有1个启用的子分类
2. 停用子分类后，历史数据保留，但新增支出不能选择该分类
3. 删除子分类前必须检查是否有支出记录（recordCount > 0时不允许删除）
4. 子分类名称在同一大类下不能重复
5. 子分类名称长度：2-20个字符

---

### 二、支出记录管理

#### 2.1 支出属性定义

**支出记录核心字段**：

| 字段 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| 记录期间 | 年月 | ✅ | 支出所属月份 | 2025-11 |
| 支出分类 | 子分类ID | ✅ | 具体支出分类 | 子女-学费 |
| 支出金额 | 金额 | ✅ | 月度汇总金额 | 3500.00 |
| 货币 | 货币代码 | ✅ | 支出货币类型 | CNY |
| 支出类型 | 枚举 | ✅ | 固定/大额 | 固定日常支出 |
| 说明 | 文本 | ⭕ | 备注信息 | 小学学费+午餐费 |
| 记录人 | 用户ID | ✅ | 记录人 | 张三 |
| 家庭 | 家庭ID | ✅ | 所属家庭 | 我的家庭 |
| 创建时间 | 时间戳 | ✅ | 自动记录 | 2025-12-10 10:30 |
| 更新时间 | 时间戳 | ✅ | 自动更新 | 2025-12-10 15:20 |

**支出类型说明**：

```
支出类型（expense_type）：
  - FIXED_DAILY: 固定日常支出
    特点：每月都有、金额相对稳定、可预测
    示例：房租、物业费、通勤交通、日常伙食

  - LARGE_IRREGULAR: 不固定大额支出
    特点：偶尔发生、金额较大、不可预测
    示例：旅游、大件购物、装修、医疗、人情礼金
```

**设计理由**：
- 固定支出：方便设置预算和预测未来支出
- 大额支出：单独统计，避免影响日常支出分析

#### 2.2 月度汇总录入模式

**核心设计**：一次性录入某月所有分类的支出（参考资产管理-批量更新界面）

**录入界面设计**：

```vue
<template>
  <div class="p-6 space-y-4">
    <!-- 页面头部 -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold text-gray-900">批量录入支出</h1>
        <select
          v-model="selectedMajorCategory"
          class="px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
        >
          <option :value="null">全部分类</option>
          <option v-for="cat in majorCategories" :key="cat.id" :value="cat.id">
            {{ cat.icon }} {{ cat.name }}
          </option>
        </select>
      </div>
      <div class="flex items-center gap-3">
        <select
          v-model="expensePeriod"
          class="px-3 py-1.5 text-sm border border-gray-300 rounded-md"
        >
          <option value="2025-12">2025年12月</option>
          <option value="2025-11">2025年11月</option>
          <!-- 动态生成近12个月 -->
        </select>
        <button
          @click="copyFromLastMonth"
          class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50"
        >
          复制上月
        </button>
        <button
          @click="saveAll"
          :disabled="saving || !hasChanges"
          class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 text-sm font-medium disabled:opacity-50"
        >
          {{ saving ? '保存中...' : '保存全部' }}
        </button>
      </div>
    </div>

    <!-- 支出分类列表 -->
    <div class="bg-white rounded-lg shadow border border-gray-200">
      <div v-if="loading" class="text-center py-8 text-gray-500 text-sm">
        加载中...
      </div>
      <div v-else-if="filteredCategories.length === 0" class="text-center py-8 text-gray-500 text-sm">
        暂无支出分类
      </div>
      <div v-else class="divide-y divide-gray-200">
        <!-- 表头 -->
        <div class="grid grid-cols-12 gap-3 px-4 py-2 bg-gray-50 text-xs font-medium text-gray-500 uppercase">
          <div class="col-span-3">分类</div>
          <div class="col-span-2 text-right">上月金额</div>
          <div class="col-span-3">本月金额</div>
          <div class="col-span-2 text-center">类型</div>
          <div class="col-span-2 text-right">差额</div>
        </div>

        <!-- 数据行 -->
        <div
          v-for="category in filteredCategories"
          :key="category.id"
          class="grid grid-cols-12 gap-3 px-4 py-2.5 hover:bg-gray-50 items-center"
        >
          <!-- 分类信息 -->
          <div class="col-span-3">
            <div class="font-medium text-gray-900 text-sm">
              {{ category.majorCategoryName }} - {{ category.minorCategoryName }}
            </div>
            <div class="text-xs text-gray-500 mt-0.5">
              {{ category.majorCategoryIcon }}
            </div>
          </div>

          <!-- 上月金额 -->
          <div class="col-span-2 text-right">
            <div class="text-sm font-semibold text-gray-900">
              ¥{{ formatNumber(lastMonthAmounts[category.id] || 0) }}
            </div>
            <div class="text-xs text-gray-400 mt-0.5">
              {{ expensePeriod ? getPreviousMonth(expensePeriod) : '-' }}
            </div>
          </div>

          <!-- 本月金额输入 -->
          <div class="col-span-3">
            <input
              v-model="categoryAmounts[category.id]"
              type="number"
              step="0.01"
              placeholder="输入金额"
              class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary"
              @input="markAsChanged(category.id)"
            />
          </div>

          <!-- 支出类型 -->
          <div class="col-span-2 text-center">
            <div class="flex items-center justify-center gap-2 text-xs">
              <label class="flex items-center gap-1 cursor-pointer">
                <input
                  type="radio"
                  :name="`type-${category.id}`"
                  value="FIXED_DAILY"
                  v-model="categoryTypes[category.id]"
                  class="w-3 h-3"
                />
                固定
              </label>
              <label class="flex items-center gap-1 cursor-pointer">
                <input
                  type="radio"
                  :name="`type-${category.id}`"
                  value="LARGE_IRREGULAR"
                  v-model="categoryTypes[category.id]"
                  class="w-3 h-3"
                />
                大额
              </label>
            </div>
          </div>

          <!-- 差额显示 -->
          <div class="col-span-2 text-right">
            <div v-if="categoryAmounts[category.id]" class="text-xs">
              <span :class="getDifferenceClass(category.id)">
                {{ formatDifference(category.id) }}
              </span>
            </div>
          </div>
        </div>

        <!-- 统计汇总 -->
        <div class="px-4 py-3 bg-gray-50 border-t border-gray-200">
          <div class="grid grid-cols-3 gap-6 text-sm">
            <div>
              <span class="text-gray-600">本月总支出：</span>
              <span class="font-bold text-lg text-gray-900">¥{{ formatNumber(totalExpense) }}</span>
            </div>
            <div>
              <span class="text-gray-600">固定日常：</span>
              <span class="font-medium text-blue-600">¥{{ formatNumber(fixedExpense) }}</span>
              <span class="text-gray-500 ml-1">({{ fixedRatio }}%)</span>
            </div>
            <div>
              <span class="text-gray-600">大额支出：</span>
              <span class="font-medium text-orange-600">¥{{ formatNumber(largeExpense) }}</span>
              <span class="text-gray-500 ml-1">({{ largeRatio }}%)</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
```

**界面特点**（参考BatchUpdate.vue设计）：

##### 2.2.1 页面布局
- ✅ **顶部操作栏**：期间选择 + 分类筛选 + 快捷操作按钮（复制上月、保存全部）
- ✅ **网格布局**：12列Grid系统，响应式布局
- ✅ **分栏显示**：
  - 分类信息（3列）：大类-子类，带图标
  - 上月金额（2列）：参考值，右对齐显示
  - 本月金额（3列）：输入框
  - 支出类型（2列）：固定/大额单选按钮
  - 差额（2列）：自动计算，颜色标识
- ✅ **底部汇总**：总支出、固定支出、大额支出占比

##### 2.2.2 交互特性
- ✅ **分类筛选**：下拉选择大类，快速过滤显示
- ✅ **上月参考**：显示上月同分类金额，便于对比
- ✅ **复制上月**：一键填充上月数据，可在此基础上修改
- ✅ **实时计算**：输入时自动计算差额、小计、占比
- ✅ **变更追踪**：记录哪些分类被修改过（hasChanges）
- ✅ **悬停高亮**：鼠标悬停行背景变色（hover:bg-gray-50）

##### 2.2.3 数据处理逻辑
```javascript
// 1. 金额输入处理
const categoryAmounts = ref({})  // { categoryId: amount }
const categoryTypes = ref({})     // { categoryId: 'FIXED_DAILY'|'LARGE_IRREGULAR' }

// 2. 上月数据加载
const loadLastMonthData = async () => {
  const lastMonth = getPreviousMonth(expensePeriod.value)
  const response = await expenseAPI.getByPeriod(lastMonth)
  lastMonthAmounts.value = response.data.reduce((acc, record) => {
    acc[record.minorCategoryId] = record.amount
    return acc
  }, {})
}

// 3. 复制上月
const copyFromLastMonth = () => {
  Object.keys(lastMonthAmounts.value).forEach(categoryId => {
    categoryAmounts.value[categoryId] = lastMonthAmounts.value[categoryId]
    markAsChanged(categoryId)
  })
}

// 4. 批量保存
const saveAll = async () => {
  const records = []
  Object.keys(categoryAmounts.value).forEach(categoryId => {
    const amount = parseFloat(categoryAmounts.value[categoryId])
    if (amount && amount > 0) {
      records.push({
        minorCategoryId: categoryId,
        amount: amount,
        expenseType: categoryTypes.value[categoryId] || 'FIXED_DAILY',
        currency: 'CNY'
      })
    }
  })

  await expenseAPI.batchSave({
    expensePeriod: expensePeriod.value,
    records: records
  })
}
```

##### 2.2.4 表单验证规则
- 金额必须 ≥ 0
- 金额最多2位小数
- 至少有一个分类有金额 > 0
- 同一期间+分类不能重复（后端唯一约束）

##### 2.2.5 用户体验优化
- 🎨 **视觉反馈**：
  - 差额正数绿色，负数红色
  - 保存按钮disabled状态灰色
  - hover状态背景色变化
- ⌨️ **快捷操作**：
  - Tab键跳转输入框
  - Enter键保存
- 📱 **响应式**：Grid布局自适应不同屏幕尺寸

#### 2.3 添加/编辑记录对话框

```vue
<!-- 添加/编辑支出记录对话框 -->
<div v-if="showRecordDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">
      {{ editingRecord ? '编辑支出记录' : '添加支出记录' }}
    </h2>
    <form @submit.prevent="submitRecordForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">支出分类</label>
        <div class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-900">
          {{ selectedMajorCategory.icon }} {{ selectedMajorCategory.name }} - {{ selectedMinorCategory.name }}
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">支出期间 *</label>
        <select
          v-model="recordFormData.expensePeriod"
          required
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
        >
          <option v-for="period in availablePeriods" :key="period" :value="period">
            {{ period }}
          </option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">支出金额 *</label>
        <div class="relative">
          <span class="absolute left-3 top-2 text-gray-500">¥</span>
          <input
            v-model="recordFormData.amount"
            type="number"
            step="0.01"
            min="0"
            required
            placeholder="0.00"
            class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
          />
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">支出类型 *</label>
        <div class="flex gap-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input
              v-model="recordFormData.expenseType"
              type="radio"
              value="FIXED_DAILY"
              class="w-4 h-4 text-primary"
            />
            <span class="text-sm text-gray-700">固定日常</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input
              v-model="recordFormData.expenseType"
              type="radio"
              value="LARGE_IRREGULAR"
              class="w-4 h-4 text-primary"
            />
            <span class="text-sm text-gray-700">大额支出</span>
          </label>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">说明</label>
        <textarea
          v-model="recordFormData.description"
          rows="3"
          placeholder="选填，例如：小学学费+午餐费"
          maxlength="200"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
        ></textarea>
        <p class="text-xs text-gray-500 mt-1">{{ recordFormData.description?.length || 0 }}/200</p>
      </div>

      <div class="flex gap-3 pt-2">
        <button
          v-if="editingRecord"
          type="button"
          @click="deleteRecord"
          class="px-4 py-2 text-red-600 border border-red-600 rounded-lg hover:bg-red-50"
        >
          删除
        </button>
        <button
          type="button"
          @click="closeRecordDialog"
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
        >
          取消
        </button>
        <button
          type="submit"
          class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90"
        >
          {{ editingRecord ? '保存' : '添加' }}
        </button>
      </div>
    </form>
  </div>
</div>
```

**表单字段说明**：
- **支出分类**：只读，显示当前选中的子分类
- **支出期间**：下拉选择（YYYY-MM格式），默认当前月份
- **支出金额**：数字输入，最多2位小数
- **支出类型**：固定日常 / 大额支出 单选
- **说明**：可选文本，最多200字符

---

## 📱 页面结构

### 页面导航

```
支出管理
  ├─ 分类与记录（ExpenseCategories.vue）
  │    ├─ Tab: 子女、衣、食、住、行、保险、人情、娱乐、经营、其他
  │    ├─ 左侧：子分类列表
  │    └─ 右侧：趋势图 + 记录列表
  │
  └─ 批量录入（ExpenseBatchUpdate.vue）
       └─ 一次性录入某月所有分类的支出
```

### 页面对比

| 功能 | 分类与记录页面 | 批量录入页面 |
|------|---------------|-------------|
| **定位** | 按分类查看和管理 | 快速月度记账 |
| **布局** | 3列布局（Tab+列表+趋势图） | 2列布局（期间+列表） |
| **数据视角** | 单个分类的历史趋势 | 所有分类的当月数据 |
| **操作方式** | 单条记录增删改 | 批量填写保存 |
| **适用场景** | 查看某类支出历史、分析趋势 | 月底集中记账 |
| **参考界面** | AccountHistory.vue | BatchUpdate.vue |

---

### 三、支出分析（未来扩展）

支出分析功能已在"功能缺口分析.md"中详细规划，包括：
- 月度分析报表
- 支出结构分析
- 趋势对比分析
- 预算执行分析

建议在MVP完成后，根据实际使用情况逐步添加。

---

## 💡 界面设计总结

### 核心设计理念

**1. 双页面模式**：
- **分类与记录页面**（参考AccountHistory.vue）：按分类查看趋势和管理记录
- **批量录入页面**（参考BatchUpdate.vue）：快速月度记账

**2. 设计优势**：
- ✅ **分离关注点**：查看 vs 录入，互不干扰
- ✅ **灵活切换**：既能详细分析单个分类，也能快速录入所有分类
- ✅ **风格统一**：完全复用现有界面模式，降低学习成本
- ✅ **操作高效**：Tab导航快速切换大类，Grid布局信息密度高

**3. 参考界面对照**：

```
支出管理 - 分类与记录              资产管理 - 账户与记录
┌─────────────────────────┐      ┌─────────────────────────┐
│ Tab: 9个固定大类         │  ←→  │ Tab: 8个资产类型         │
├─────────────────────────┤      ├─────────────────────────┤
│ 左: 子分类列表           │  ←→  │ 左: 账户列表             │
│ 右上: 分类信息+添加按钮  │  ←→  │ 右上: 账户信息+添加按钮  │
│ 右下左: 趋势图           │  ←→  │ 右下左: 趋势图           │
│ 右下右: 记录列表         │  ←→  │ 右下右: 记录列表         │
└─────────────────────────┘      └─────────────────────────┘

支出管理 - 批量录入                资产管理 - 批量更新
┌─────────────────────────┐      ┌─────────────────────────┐
│ 顶部: 期间+筛选+保存     │  ←→  │ 顶部: 日期+筛选+保存     │
├─────────────────────────┤      ├─────────────────────────┤
│ Grid列表:                │  ←→  │ Grid列表:                │
│ - 分类(3列)              │      │ - 账户(3列)              │
│ - 上月金额(2列)          │      │ - 之前金额(2列)          │
│ - 本月输入(3列)          │      │ - 新金额输入(3列)        │
│ - 类型(2列)              │      │ - 差额(3列)              │
│ - 差额(2列)              │      │                          │
├─────────────────────────┤      ├─────────────────────────┤
│ 底部: 统计汇总           │      │ （无底部汇总）           │
└─────────────────────────┘      └─────────────────────────┘
```

**4. 关键交互模式复用**：

| 交互模式 | 资产管理 | 支出管理 |
|---------|---------|---------|
| Tab切换大类 | 现金类、股票等 | 子女、衣、食等 |
| 左侧列表选中高亮 | bg-primary/10 + border-l-4 | 完全一致 |
| 悬停显示操作按钮 | opacity-0 → 100 | 完全一致 |
| 趋势图时间范围 | 6月/1年/3年/全部 | 完全一致 |
| 记录表格 | 日期/金额/操作 | 期间/金额/类型/操作 |
| 对话框样式 | fixed + bg-opacity-50 | 完全一致 |
| 批量保存逻辑 | hasChanges控制按钮 | 完全一致 |

---

## 🎯 用户使用流程

### 场景1：月底集中记账

1. 进入"支出管理 → 批量录入"
2. 选择期间"2025-11"
3. 点击"复制上月"自动填充固定支出
4. 修改有变化的金额，填写新增支出
5. 点击"保存全部"，完成月度记账

**耗时**：约3-5分钟（假设30个分类）

### 场景2：查看餐饮支出趋势

1. 进入"支出管理 → 分类与记录"
2. 点击Tab"食"
3. 左侧点击"外出就餐"
4. 右侧查看近12个月趋势图
5. 发现9月特别高，查看记录列表找原因

**耗时**：约30秒

### 场景3：添加临时大额支出

1. 在"分类与记录"页面
2. 点击Tab"娱乐"→ 选择"旅游"
3. 点击"添加记录"
4. 填写：期间2025-11、金额15000、类型大额、说明"国庆云南旅游"
5. 保存

**耗时**：约1分钟

---

## 💾 数据库设计

### 4.1 表结构设计

#### 4.1.1 支出大类表 (expense_categories_major)

```sql
CREATE TABLE expense_categories_major (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  code VARCHAR(50) NOT NULL UNIQUE COMMENT '大类编码（CHILDREN, CLOTHING等）',
  name VARCHAR(50) NOT NULL COMMENT '大类名称',
  icon VARCHAR(50) COMMENT '图标（emoji或图标类名）',
  color VARCHAR(20) COMMENT '颜色代码',
  sort_order INT NOT NULL DEFAULT 0 COMMENT '排序顺序',
  is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否启用',
  description TEXT COMMENT '说明',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  KEY idx_is_active (is_active),
  KEY idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='支出大类表';

-- 初始数据
INSERT INTO expense_categories_major
  (code, name, icon, color, sort_order)
VALUES
  ('CHILDREN', '子女', '👶', '#FF6B6B', 1),
  ('CLOTHING', '衣', '👔', '#4ECDC4', 2),
  ('FOOD', '食', '🍜', '#95E1D3', 3),
  ('HOUSING', '住', '🏠', '#F38181', 4),
  ('TRANSPORTATION', '行', '🚗', '#AA96DA', 5),
  ('INSURANCE', '保险', '🛡️', '#FCBAD3', 6),
  ('SOCIAL', '人情', '🎁', '#FFFFD2', 7),
  ('ENTERTAINMENT', '娱乐', '🎮', '#A8D8EA', 8),
  ('BUSINESS', '经营', '💼', '#FFB6B9', 9),
  ('OTHER', '其他', '📦', '#C7CEEA', 10);
```

#### 4.1.2 支出子分类表 (expense_categories_minor)

```sql
CREATE TABLE expense_categories_minor (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  major_category_id BIGINT NOT NULL COMMENT '所属大类ID',
  name VARCHAR(100) NOT NULL COMMENT '子分类名称',
  is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否启用',
  is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否系统默认分类',
  sort_order INT NOT NULL DEFAULT 0 COMMENT '排序顺序',
  description TEXT COMMENT '说明',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  FOREIGN KEY (major_category_id) REFERENCES expense_categories_major(id),
  UNIQUE KEY uk_major_name (major_category_id, name),
  KEY idx_is_active (is_active),
  KEY idx_major_category (major_category_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='支出子分类表';

-- 初始数据见附录A
```

#### 4.1.3 支出记录表 (expense_records)

```sql
CREATE TABLE expense_records (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  family_id BIGINT NOT NULL COMMENT '家庭ID',
  user_id BIGINT NOT NULL COMMENT '记录人ID',

  -- 期间与分类
  expense_year INT NOT NULL COMMENT '支出年份',
  expense_month INT NOT NULL COMMENT '支出月份',
  expense_period VARCHAR(7) NOT NULL COMMENT '支出期间（YYYY-MM）',
  major_category_id BIGINT NOT NULL COMMENT '大类ID',
  minor_category_id BIGINT NOT NULL COMMENT '子分类ID',

  -- 金额
  amount DECIMAL(18, 2) NOT NULL COMMENT '支出金额',
  currency VARCHAR(10) NOT NULL DEFAULT 'CNY' COMMENT '货币代码',
  amount_in_base_currency DECIMAL(18, 2) COMMENT '基准货币金额（自动计算）',
  exchange_rate DECIMAL(18, 8) COMMENT '汇率（记录时汇率）',

  -- 类型与说明
  expense_type VARCHAR(20) NOT NULL COMMENT '支出类型（FIXED_DAILY/LARGE_IRREGULAR）',
  description TEXT COMMENT '说明',

  -- 审计字段
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  FOREIGN KEY (family_id) REFERENCES families(id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (major_category_id) REFERENCES expense_categories_major(id),
  FOREIGN KEY (minor_category_id) REFERENCES expense_categories_minor(id),

  UNIQUE KEY uk_period_category (family_id, expense_period, minor_category_id),
  KEY idx_family_period (family_id, expense_year, expense_month),
  KEY idx_expense_period (expense_period),
  KEY idx_major_category (major_category_id),
  KEY idx_minor_category (minor_category_id),
  KEY idx_expense_type (expense_type),
  KEY idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='支出记录表';
```

**约束说明**：
- `uk_period_category`：同一家庭、同一期间、同一分类只能有一条记录（月度汇总特性）
- 金额字段使用DECIMAL(18,2)保证精度
- expense_period冗余字段方便查询
- amount_in_base_currency自动计算并存储，避免重复计算

#### 4.1.4 草稿表 (expense_drafts)

```sql
CREATE TABLE expense_drafts (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  family_id BIGINT NOT NULL COMMENT '家庭ID',
  user_id BIGINT NOT NULL COMMENT '用户ID',
  expense_period VARCHAR(7) NOT NULL COMMENT '支出期间（YYYY-MM）',
  draft_data JSON NOT NULL COMMENT '草稿数据（JSON格式）',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  FOREIGN KEY (family_id) REFERENCES families(id),
  FOREIGN KEY (user_id) REFERENCES users(id),

  UNIQUE KEY uk_user_period (user_id, expense_period),
  KEY idx_family_period (family_id, expense_period)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='支出草稿表';
```

**draft_data JSON结构示例**：
```json
{
  "period": "2025-11",
  "records": [
    {
      "majorCategoryId": 1,
      "minorCategoryId": 1,
      "amount": 3500.00,
      "currency": "CNY",
      "expenseType": "FIXED_DAILY",
      "description": "小学学费"
    },
    {
      "majorCategoryId": 1,
      "minorCategoryId": 2,
      "amount": 1200.00,
      "currency": "CNY",
      "expenseType": "FIXED_DAILY",
      "description": "数学英语"
    }
  ],
  "totalAmount": 4700.00,
  "lastModified": "2025-12-10T15:30:00"
}
```

### 4.2 索引策略

**查询场景与索引匹配**：

| 查询场景 | 使用索引 | 说明 |
|---------|---------|------|
| 某月支出列表 | idx_family_period | 覆盖 family_id + year + month |
| 某分类历史 | idx_minor_category | 快速定位分类 |
| 时间范围查询 | idx_expense_period | 字符串比较效率高 |
| 固定/大额筛选 | idx_expense_type | 快速过滤类型 |
| 最新记录 | idx_created_at | 按时间降序查询 |

---

## 🔌 API接口设计

### 5.1 分类管理接口

#### 5.1.1 获取大类列表

```
GET /api/expense-categories/major

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "code": "CHILDREN",
      "name": "子女",
      "icon": "👶",
      "color": "#FF6B6B",
      "sortOrder": 1,
      "isActive": true
    },
    ...
  ]
}
```

#### 5.1.2 获取子分类列表（含大类信息）

```
GET /api/expense-categories/minor/tree

Response:
{
  "success": true,
  "data": [
    {
      "majorCategory": {
        "id": 1,
        "code": "CHILDREN",
        "name": "子女",
        "icon": "👶",
        "color": "#FF6B6B"
      },
      "minorCategories": [
        {
          "id": 1,
          "name": "学费",
          "isActive": true,
          "isDefault": true,
          "recordCount": 12
        },
        {
          "id": 2,
          "name": "补习班",
          "isActive": true,
          "isDefault": true,
          "recordCount": 8
        }
      ]
    },
    ...
  ]
}
```

#### 5.1.3 新增子分类

```
POST /api/expense-categories/minor

Request:
{
  "majorCategoryId": 1,
  "name": "兴趣班",
  "description": "钢琴、绘画等兴趣班费用"
}

Response:
{
  "success": true,
  "message": "子分类创建成功",
  "data": {
    "id": 15,
    "majorCategoryId": 1,
    "name": "兴趣班",
    "isActive": true,
    "isDefault": false,
    "sortOrder": 4
  }
}
```

#### 5.1.4 更新子分类

```
PUT /api/expense-categories/minor/{id}

Request:
{
  "name": "课外辅导",
  "description": "数学、英语等课外辅导",
  "isActive": true
}

Response:
{
  "success": true,
  "message": "子分类更新成功"
}
```

#### 5.1.5 删除子分类

```
DELETE /api/expense-categories/minor/{id}

Response (成功):
{
  "success": true,
  "message": "子分类删除成功"
}

Response (失败 - 有关联记录):
{
  "success": false,
  "message": "该分类下有12条支出记录，无法删除。请先停用该分类。"
}
```

### 5.2 支出记录接口

#### 5.2.1 批量保存/更新某月支出

```
POST /api/expense-records/batch

Request:
{
  "familyId": 1,
  "expensePeriod": "2025-11",
  "records": [
    {
      "minorCategoryId": 1,
      "amount": 3500.00,
      "currency": "CNY",
      "expenseType": "FIXED_DAILY",
      "description": "小学学费"
    },
    {
      "minorCategoryId": 2,
      "amount": 1200.00,
      "currency": "CNY",
      "expenseType": "FIXED_DAILY",
      "description": "数学英语"
    },
    ...
  ]
}

Response:
{
  "success": true,
  "message": "支出记录保存成功",
  "data": {
    "savedCount": 15,
    "totalAmount": 15230.00,
    "fixedAmount": 12500.00,
    "largeAmount": 2730.00
  }
}
```

**业务逻辑**：
1. 先删除该期间该家庭的所有记录（软删除或物理删除）
2. 批量插入新记录（金额>0的）
3. 自动计算基准货币金额
4. 返回统计信息

#### 5.2.2 查询某月支出记录

```
GET /api/expense-records/period?familyId=1&period=2025-11

Response:
{
  "success": true,
  "data": {
    "period": "2025-11",
    "records": [
      {
        "id": 101,
        "majorCategoryId": 1,
        "majorCategoryName": "子女",
        "minorCategoryId": 1,
        "minorCategoryName": "学费",
        "amount": 3500.00,
        "currency": "CNY",
        "amountInBaseCurrency": 495.14,
        "expenseType": "FIXED_DAILY",
        "description": "小学学费",
        "createdAt": "2025-12-01T10:30:00",
        "updatedAt": "2025-12-05T15:20:00"
      },
      ...
    ],
    "summary": {
      "totalAmount": 15230.00,
      "fixedAmount": 12500.00,
      "largeAmount": 2730.00,
      "recordCount": 15
    }
  }
}
```

#### 5.2.3 查询支出历史（分页）

```
GET /api/expense-records/list

Query Parameters:
- familyId (必填): 家庭ID
- startPeriod: 开始期间（YYYY-MM）
- endPeriod: 结束期间（YYYY-MM）
- majorCategoryId: 大类ID筛选
- minorCategoryId: 子分类ID筛选
- expenseType: 支出类型筛选（FIXED_DAILY/LARGE_IRREGULAR）
- page: 页码（默认1）
- pageSize: 每页条数（默认20）
- sortBy: 排序字段（period/amount）
- sortOrder: 排序方向（asc/desc）

Response:
{
  "success": true,
  "data": {
    "records": [...],
    "pagination": {
      "total": 120,
      "page": 1,
      "pageSize": 20,
      "totalPages": 6
    },
    "summary": {
      "totalAmount": 152300.00,
      "fixedAmount": 125000.00,
      "largeAmount": 27300.00,
      "avgMonthlyAmount": 15230.00
    }
  }
}
```

#### 5.2.4 更新单条记录

```
PUT /api/expense-records/{id}

Request:
{
  "amount": 3600.00,
  "expenseType": "FIXED_DAILY",
  "description": "小学秋季学费+午餐费"
}

Response:
{
  "success": true,
  "message": "支出记录更新成功"
}
```

#### 5.2.5 删除单条记录

```
DELETE /api/expense-records/{id}

Response:
{
  "success": true,
  "message": "支出记录删除成功"
}
```

#### 5.2.6 复制上月支出

```
POST /api/expense-records/copy-from-last-month

Request:
{
  "familyId": 1,
  "targetPeriod": "2025-12"
}

Response:
{
  "success": true,
  "message": "已复制2025-11的支出记录",
  "data": {
    "sourcePeriod": "2025-11",
    "targetPeriod": "2025-12",
    "copiedCount": 15,
    "records": [...]
  }
}
```

### 5.3 草稿接口

#### 5.3.1 保存草稿

```
POST /api/expense-drafts

Request:
{
  "familyId": 1,
  "expensePeriod": "2025-11",
  "draftData": { ... }
}

Response:
{
  "success": true,
  "message": "草稿保存成功"
}
```

#### 5.3.2 获取草稿

```
GET /api/expense-drafts?familyId=1&period=2025-11

Response:
{
  "success": true,
  "data": {
    "id": 5,
    "draftData": { ... },
    "updatedAt": "2025-12-10T15:30:00"
  }
}
```

### 5.4 统计分析接口

#### 5.4.1 月度统计

```
GET /api/expense-statistics/monthly?familyId=1&period=2025-11

Response:
{
  "success": true,
  "data": {
    "period": "2025-11",
    "totalAmount": 15230.00,
    "fixedAmount": 12500.00,
    "largeAmount": 2730.00,
    "fixedRatio": 0.82,
    "largeRatio": 0.18,
    "momGrowthRate": 0.052,
    "yoyGrowthRate": 0.087,
    "byMajorCategory": [
      {
        "majorCategoryId": 4,
        "majorCategoryName": "住",
        "amount": 8000.00,
        "ratio": 0.525
      },
      {
        "majorCategoryId": 3,
        "majorCategoryName": "食",
        "amount": 4600.00,
        "ratio": 0.302
      },
      ...
    ],
    "topCategories": [
      {
        "minorCategoryName": "住-房贷",
        "amount": 8000.00,
        "ratio": 0.525
      },
      ...
    ]
  }
}
```

#### 5.4.2 时间范围趋势

```
GET /api/expense-statistics/trend

Query Parameters:
- familyId (必填)
- startPeriod (必填)
- endPeriod (必填)
- majorCategoryId (可选): 指定大类
- expenseType (可选): FIXED_DAILY/LARGE_IRREGULAR

Response:
{
  "success": true,
  "data": {
    "periods": ["2025-01", "2025-02", ..., "2025-11"],
    "totalAmounts": [14200, 13800, ..., 15230],
    "fixedAmounts": [11500, 11200, ..., 12500],
    "largeAmounts": [2700, 2600, ..., 2730],
    "avgAmount": 14580.00,
    "maxAmount": 16200.00,
    "minAmount": 13100.00,
    "volatility": 0.085
  }
}
```

#### 5.4.3 分类结构分析

```
GET /api/expense-statistics/structure

Query Parameters:
- familyId (必填)
- startPeriod (必填)
- endPeriod (必填)

Response:
{
  "success": true,
  "data": {
    "totalAmount": 152300.00,
    "byMajorCategory": [
      {
        "majorCategoryId": 4,
        "majorCategoryName": "住",
        "amount": 80000.00,
        "ratio": 0.525,
        "avgMonthly": 8000.00
      },
      ...
    ],
    "byMinorCategory": [
      {
        "majorCategoryName": "住",
        "minorCategoryName": "房贷",
        "amount": 80000.00,
        "ratio": 0.525
      },
      ...
    ]
  }
}
```

---

## 🎨 用户体验设计

### 6.1 交互体验优化

#### 6.1.1 快捷键支持
- `Ctrl/Cmd + S`：保存草稿
- `Ctrl/Cmd + Enter`：提交
- `Tab`：跳转到下一个输入框
- `Shift + Tab`：跳转到上一个输入框
- `Esc`：关闭对话框

#### 6.1.2 智能提示
- 金额输入自动格式化（千分位分隔符）
- 自动计算小计和总计
- 实时显示固定/大额占比
- 异常金额提醒（如超过历史均值2倍）

#### 6.1.3 数据验证
- 前端实时验证（减少提交错误）
- 后端二次验证（保证数据安全）
- 友好的错误提示

#### 6.1.4 移动端适配
- 响应式布局
- 触摸优化（按钮间距）
- 简化批量录入界面（折叠大类）

### 6.2 数据可视化

#### 6.2.1 图表类型
- 折线图：趋势分析
- 柱状图：对比分析
- 饼图：结构分析
- 环形图：双层分类结构
- 雷达图：多维度评估（可选）

#### 6.2.2 颜色方案
- 使用大类预设颜色
- 固定支出：蓝色系
- 大额支出：橙色系
- 增长：绿色
- 下降：红色

---

## 📱 页面结构

### 7.1 页面层级

```
支出管理
  ├─ 批量录入（默认页）
  ├─ 支出历史
  ├─ 支出分析
  └─ 分类设置
```

### 7.2 导航设计

**顶部Tab导航**：

```
┌────────────────────────────────────────────────────┐
│ [批量录入] [支出历史] [支出分析] [分类设置]        │
└────────────────────────────────────────────────────┘
```

---

## ⚙️ 技术实现要点

### 8.1 前端技术栈
- **Vue 3 + Composition API**：组件开发
- **Tailwind CSS**：样式框架（与现有系统一致）
- **Chart.js**：图表库（趋势分析）
- **chartjs-adapter-date-fns**：时间轴支持
- **Axios**：HTTP客户端
- **Vite**：构建工具

### 8.2 后端技术栈
- **Spring Boot 3.2.0**：应用框架
- **MyBatis Plus**：ORM框架
- **MySQL 8.0**：数据库
- **Redis**：缓存（可选，用于分类数据缓存）

### 8.3 性能优化
- 分类数据缓存（大类、子分类不常变化）
- 分页查询优化
- 索引优化
- 批量操作事务控制

### 8.4 数据一致性
- 汇率快照：记录时保存汇率，避免历史数据变化
- 基准货币金额：预计算并存储，提升查询性能
- 软删除：分类停用而非删除，保留历史引用

---

## 🔄 迭代计划

### 第一阶段（MVP - 2周）
- ✅ 数据库表结构设计与创建
- ✅ 分类管理（大类、子分类CRUD）
- ✅ 批量录入功能
- ✅ 基础查询功能

### 第二阶段（功能完善 - 1周）
- ✅ 支出历史查询与编辑
- ✅ 草稿功能
- ✅ 复制上月功能
- ✅ 基础统计图表

### 第三阶段（分析增强 - 1周）
- ✅ 月度分析报表
- ✅ 趋势分析
- ✅ 结构分析
- ✅ 智能洞察

### 第四阶段（优化 - 持续）
- ⭕ 移动端适配
- ⭕ 性能优化
- ⭕ 用户体验优化
- ⭕ 数据导入导出

---

## 📌 附录

### 附录A：子分类初始化SQL

```sql
-- 子女
INSERT INTO expense_categories_minor (major_category_id, name, is_default, sort_order)
SELECT id, '学费', TRUE, 1 FROM expense_categories_major WHERE code='CHILDREN'
UNION ALL SELECT id, '补习班', TRUE, 2 FROM expense_categories_major WHERE code='CHILDREN'
UNION ALL SELECT id, '玩具书籍', TRUE, 3 FROM expense_categories_major WHERE code='CHILDREN'
UNION ALL SELECT id, '其他', TRUE, 99 FROM expense_categories_major WHERE code='CHILDREN';

-- 衣
INSERT INTO expense_categories_minor (major_category_id, name, is_default, sort_order)
SELECT id, '服装', TRUE, 1 FROM expense_categories_major WHERE code='CLOTHING'
UNION ALL SELECT id, '鞋帽', TRUE, 2 FROM expense_categories_major WHERE code='CLOTHING'
UNION ALL SELECT id, '配饰', TRUE, 3 FROM expense_categories_major WHERE code='CLOTHING'
UNION ALL SELECT id, '其他', TRUE, 99 FROM expense_categories_major WHERE code='CLOTHING';

-- 食
INSERT INTO expense_categories_minor (major_category_id, name, is_default, sort_order)
SELECT id, '外出就餐', TRUE, 1 FROM expense_categories_major WHERE code='FOOD'
UNION ALL SELECT id, '食材采购', TRUE, 2 FROM expense_categories_major WHERE code='FOOD'
UNION ALL SELECT id, '零食饮料', TRUE, 3 FROM expense_categories_major WHERE code='FOOD'
UNION ALL SELECT id, '其他', TRUE, 99 FROM expense_categories_major WHERE code='FOOD';

-- 住
INSERT INTO expense_categories_minor (major_category_id, name, is_default, sort_order)
SELECT id, '房租/房贷', TRUE, 1 FROM expense_categories_major WHERE code='HOUSING'
UNION ALL SELECT id, '物业费', TRUE, 2 FROM expense_categories_major WHERE code='HOUSING'
UNION ALL SELECT id, '水电气费', TRUE, 3 FROM expense_categories_major WHERE code='HOUSING'
UNION ALL SELECT id, '网络电话费', TRUE, 4 FROM expense_categories_major WHERE code='HOUSING'
UNION ALL SELECT id, '维修装修', TRUE, 5 FROM expense_categories_major WHERE code='HOUSING'
UNION ALL SELECT id, '其他', TRUE, 99 FROM expense_categories_major WHERE code='HOUSING';

-- 行
INSERT INTO expense_categories_minor (major_category_id, name, is_default, sort_order)
SELECT id, '公共交通', TRUE, 1 FROM expense_categories_major WHERE code='TRANSPORTATION'
UNION ALL SELECT id, '打车', TRUE, 2 FROM expense_categories_major WHERE code='TRANSPORTATION'
UNION ALL SELECT id, '加油', TRUE, 3 FROM expense_categories_major WHERE code='TRANSPORTATION'
UNION ALL SELECT id, '停车费', TRUE, 4 FROM expense_categories_major WHERE code='TRANSPORTATION'
UNION ALL SELECT id, '车辆维护', TRUE, 5 FROM expense_categories_major WHERE code='TRANSPORTATION'
UNION ALL SELECT id, '车辆保险', TRUE, 6 FROM expense_categories_major WHERE code='TRANSPORTATION'
UNION ALL SELECT id, '其他', TRUE, 99 FROM expense_categories_major WHERE code='TRANSPORTATION';

-- 保险
INSERT INTO expense_categories_minor (major_category_id, name, is_default, sort_order)
SELECT id, '医疗保险', TRUE, 1 FROM expense_categories_major WHERE code='INSURANCE'
UNION ALL SELECT id, '人寿保险', TRUE, 2 FROM expense_categories_major WHERE code='INSURANCE'
UNION ALL SELECT id, '意外险', TRUE, 3 FROM expense_categories_major WHERE code='INSURANCE'
UNION ALL SELECT id, '财产险', TRUE, 4 FROM expense_categories_major WHERE code='INSURANCE'
UNION ALL SELECT id, '其他', TRUE, 99 FROM expense_categories_major WHERE code='INSURANCE';

-- 人情
INSERT INTO expense_categories_minor (major_category_id, name, is_default, sort_order)
SELECT id, '礼金', TRUE, 1 FROM expense_categories_major WHERE code='SOCIAL'
UNION ALL SELECT id, '请客', TRUE, 2 FROM expense_categories_major WHERE code='SOCIAL'
UNION ALL SELECT id, '送礼', TRUE, 3 FROM expense_categories_major WHERE code='SOCIAL'
UNION ALL SELECT id, '其他', TRUE, 99 FROM expense_categories_major WHERE code='SOCIAL';

-- 娱乐
INSERT INTO expense_categories_minor (major_category_id, name, is_default, sort_order)
SELECT id, '旅游', TRUE, 1 FROM expense_categories_major WHERE code='ENTERTAINMENT'
UNION ALL SELECT id, '购物', TRUE, 2 FROM expense_categories_major WHERE code='ENTERTAINMENT'
UNION ALL SELECT id, '电影/演出', TRUE, 3 FROM expense_categories_major WHERE code='ENTERTAINMENT'
UNION ALL SELECT id, '运动健身', TRUE, 4 FROM expense_categories_major WHERE code='ENTERTAINMENT'
UNION ALL SELECT id, '爱好兴趣', TRUE, 5 FROM expense_categories_major WHERE code='ENTERTAINMENT'
UNION ALL SELECT id, '其他', TRUE, 99 FROM expense_categories_major WHERE code='ENTERTAINMENT';

-- 经营
INSERT INTO expense_categories_minor (major_category_id, name, is_default, sort_order)
SELECT id, '办公成本', TRUE, 1 FROM expense_categories_major WHERE code='BUSINESS'
UNION ALL SELECT id, '营销费用', TRUE, 2 FROM expense_categories_major WHERE code='BUSINESS'
UNION ALL SELECT id, '人员工资', TRUE, 3 FROM expense_categories_major WHERE code='BUSINESS'
UNION ALL SELECT id, '投资支出', TRUE, 4 FROM expense_categories_major WHERE code='BUSINESS'
UNION ALL SELECT id, '其他', TRUE, 99 FROM expense_categories_major WHERE code='BUSINESS';

-- 其他
INSERT INTO expense_categories_minor (major_category_id, name, is_default, sort_order)
SELECT id, '未分类', TRUE, 1 FROM expense_categories_major WHERE code='OTHER';
```

### 附录B：业务流程图

#### 批量录入流程

```
开始
  ↓
选择期间 (YYYY-MM)
  ↓
[是否有草稿?]
  ├─ 是 → 加载草稿数据
  └─ 否 → [是否复制上月?]
           ├─ 是 → 加载上月数据
           └─ 否 → 空白表单
  ↓
输入/修改各分类金额
  ↓
[用户操作?]
  ├─ 保存草稿 → 保存到草稿表 → 继续编辑
  ├─ 清空 → 确认 → 清空表单
  └─ 提交 → 表单验证
               ↓
          [验证通过?]
               ├─ 否 → 显示错误 → 继续编辑
               └─ 是 → 保存到expense_records表
                         ↓
                    删除草稿
                         ↓
                    显示成功提示
                         ↓
                       结束
```

---

**文档版本**：v1.0
**最后更新**：2025-12-10
**维护者**：Claude Code
**状态**：待评审
