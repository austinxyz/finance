# 收入管理模块 - 需求文档

## 1. 概述

收入管理模块是家庭财务管理系统的核心模块之一，用于记录、分类、分析家庭的各类收入来源。

### 1.1 设计理念

- **月度汇总记录**：采用月度汇总方式，而非每日流水账，减少记录工作量
- **分层分类**：采用大类+子分类两层结构，平衡灵活性和管理成本
- **多货币支持**：支持多种货币记录，自动转换为基准货币统计
- **灵活扩展**：支持自定义收入分类，适应不同家庭收入结构

## 2. 功能需求

### 2.1 分类管理

#### 2.1.1 大类管理

**系统默认大类**（可扩展）：
1. 工资收入 (SALARY)
2. 投资收益 (INVESTMENT_INCOME)
3. 其他收入 (OTHER_INCOME)

**大类属性**：
- 编码（英文代码，唯一）
- 中文名称
- 英文名称
- 图标（emoji 或图标类名）
- 颜色代码（用于界面展示）
- 排序顺序
- 启用状态

**功能**：
- 查询所有大类列表
- 新增大类
- 编辑大类（名称、图标、颜色、排序）
- 停用/启用大类

#### 2.1.2 子分类管理

**子分类属性**：
- 所属大类
- 中文名称（自定义）
- 英文名称（自定义）
- 是否系统默认
- 排序顺序
- 启用状态
- 说明

**功能**：
- 查询所有分类（大类+子分类树形结构）
- 新增子分类
- 编辑子分类（名称、排序、说明）
- 停用/删除子分类
  - 有关联记录：只能停用
  - 无关联记录：可以删除

**UI设计**：
- 列表展示：大类折叠面板 + 子分类卡片列表
- 每个子分类卡片显示：
  - 大类图标 + 子分类名称
  - 关联记录数量
  - 编辑/停用按钮

### 2.2 收入记录管理

#### 2.2.1 批量录入

**录入方式**：按月份批量录入，一次性完成当月所有分类的收入记录

**选择器**：
- 家庭选择
- 货币选择（CNY/USD/EUR等）
- 月份选择（YYYY-MM格式）

**录入界面**：
- 表格形式展示所有子分类
- 每行包含：
  - 大类图标 + 子分类名称
  - 前3个月历史数据（只读，辅助参考）
  - 当月金额输入框

**历史数据展示**：
- 显示前3个月同分类的收入金额
- 帮助用户参考历史趋势
- 工资收入通常较为稳定

**顶部统计**：
- 前3个月总收入
- 本月总收入
- 按大类分组的收入汇总

**排序规则**：
1. 按大类排序
2. 同大类内按子分类ID排序
3. 有历史数据的优先排在前面

**保存逻辑**：
- 同一期间+同一分类+同一货币，只能有一条记录
- 新录入：创建新记录
- 已存在：更新金额
- 金额为0：删除记录

**UI设计**：
```
┌─────────────────────────────────────────────────┐
│ 家庭: [选择器] 货币: [选择器] 月份: [选择器]    [保存全部] │
├─────────────────────────────────────────────────┤
│ 统计：                                          │
│ 11月总收入: $8.5K                               │
│ 12月总收入: $9.0K                               │
│ 01月总收入: $8.8K                               │
│ 本月总收入: $9.2K                               │
├─────────────────────────────────────────────────┤
│ 分类          │  11月  │  12月  │  01月  │ 02月       │
├─────────────────────────────────────────────────┤
│ 💰 工资 - 基本工资 │  5000  │  5000  │  5000  │ [$___]     │
│ 💰 工资 - 奖金     │  1000  │  2000  │  1500  │ [$___]     │
│ 📈 投资 - 股息     │   500  │   500  │   500  │ [$___]     │
│ ...                                            │
└─────────────────────────────────────────────────┘
```

#### 2.2.2 记录查询

**查询方式**：
- 按期间查询：单个月份
- 按期间范围查询：起止期间

**返回数据**：
- 收入记录列表
- 包含大类、子分类名称、图标
- 金额、货币
- 说明、创建/更新时间

### 2.3 年度分析

#### 2.3.1 年度大类汇总

**查询条件**：
- 家庭 + 年份 + 货币（支持All模式转USD）

**统计维度**：
- 按大类汇总年度收入
- All模式：自动转换为USD统一统计

**显示方式**：
- 饼图展示大类占比
- 表格详细列表
- 按金额降序排列

**UI设计**：
```
┌─────────────────────────────────────────────────┐
│ 2025年度大类收入分析 - All (USD)                 │
├─────────────────────────────────────────────────┤
│           [饼图展示各大类占比]                    │
├─────────────────────────────────────────────────┤
│ 大类       │ 金额     │ 占比                     │
├─────────────────────────────────────────────────┤
│ 💰 工资    │ $80,000  │ ████████████ 75%         │
│ 📈 投资    │ $15,000  │ ███ 14%                  │
│ 🎁 其他    │ $12,000  │ ██ 11%                   │
└─────────────────────────────────────────────────┘
```

#### 2.3.2 年度小类明细

**查询条件**：
- 家庭 + 年份 + 大类 + 货币

**统计维度**：
- 按小类汇总某大类下的年度收入
- 显示金额、占比

**UI设计**：
```
┌─────────────────────────────────────────────────┐
│ 2025年度 - 工资收入 - 小类明细 (USD)             │
├─────────────────────────────────────────────────┤
│ 子分类     │ 金额     │ 占比                     │
├─────────────────────────────────────────────────┤
│ 基本工资   │ $60,000  │ ████████ 75%             │
│ 年终奖     │ $15,000  │ ███ 19%                  │
│ 季度奖金   │ $5,000   │ █ 6%                     │
└─────────────────────────────────────────────────┘
```

#### 2.3.3 月度趋势

**查询条件**：
- 家庭 + 年份 + 大类 + 子分类 + 货币

**显示内容**：
- 某个子分类的12个月收入趋势
- 柱状图展示

**用途**：
- 识别收入规律
- 发现异常波动
- 分析季节性收入

**UI设计**：
```
┌─────────────────────────────────────────────────┐
│ 2025年度 - 基本工资 - 月度趋势 (USD)             │
├─────────────────────────────────────────────────┤
│           [柱状图：12个月的收入金额]              │
├─────────────────────────────────────────────────┤
│ 月份 │ 01   │ 02   │ 03   │ ... │ 12            │
│ 金额 │ 5000 │ 5000 │ 5000 │ ... │ 5000          │
└─────────────────────────────────────────────────┘
```

#### 2.3.4 年度汇总刷新

**说明**：提供手动刷新年度汇总数据的功能

**触发方式**：
- 用户主动点击刷新按钮
- 自动调用后端存储过程重新计算

**查询条件**：
- 家庭 + 年份 + 货币

**功能**：
- 删除旧的汇总数据
- 重新从收入记录表汇总
- 计算大类、小类、总计
- 按货币统计（支持All模式转USD）

## 3. 数据模型

### 3.1 收入大类表 (income_categories_major)

```sql
id                  BIGINT          -- 主键ID
code                VARCHAR(50)     -- 大类编码（SALARY, INVESTMENT等）
name                VARCHAR(50)     -- 中文名称
english_name        VARCHAR(50)     -- 英文名称
icon                VARCHAR(50)     -- 图标
color               VARCHAR(20)     -- 颜色代码
sort_order          INT             -- 排序顺序
is_active           BOOLEAN         -- 是否启用
description         TEXT            -- 说明
created_at          TIMESTAMP       -- 创建时间
updated_at          TIMESTAMP       -- 更新时间
```

### 3.2 收入子分类表 (income_categories_minor)

```sql
id                  BIGINT          -- 主键ID
major_category_id   BIGINT          -- 所属大类ID
name                VARCHAR(100)    -- 中文名称
english_name        VARCHAR(100)    -- 英文名称
is_active           BOOLEAN         -- 是否启用
is_default          BOOLEAN         -- 是否系统默认分类
sort_order          INT             -- 排序顺序
description         TEXT            -- 说明
created_at          TIMESTAMP       -- 创建时间
updated_at          TIMESTAMP       -- 更新时间

UNIQUE (major_category_id, name)    -- 同一大类下子分类名称唯一
```

### 3.3 收入记录表 (income_records)

```sql
id                      BIGINT          -- 主键ID
family_id               BIGINT          -- 家庭ID
user_id                 BIGINT          -- 记录人ID
income_year             INT             -- 收入年份
income_month            INT             -- 收入月份
income_period           VARCHAR(7)      -- 收入期间（YYYY-MM）
major_category_id       BIGINT          -- 大类ID
minor_category_id       BIGINT          -- 子分类ID
amount                  DECIMAL(18,2)   -- 收入金额
currency                VARCHAR(10)     -- 货币代码
description             TEXT            -- 说明
created_at              TIMESTAMP       -- 创建时间
updated_at              TIMESTAMP       -- 更新时间

UNIQUE (family_id, income_period, minor_category_id, currency)
-- 同一期间同一分类同一货币只有一条记录
```

### 3.4 年度收入汇总表 (annual_income_summary)

```sql
id                      BIGINT          -- 主键ID
family_id               BIGINT          -- 家庭ID
summary_year            INT             -- 汇总年份
major_category_id       BIGINT          -- 大类ID（0表示总计）
minor_category_id       BIGINT          -- 子分类ID（NULL表示大类汇总）
actual_income_amount    DECIMAL(18,2)   -- 实际收入金额
currency                VARCHAR(10)     -- 货币类型
created_at              TIMESTAMP       -- 创建时间
updated_at              TIMESTAMP       -- 更新时间

UNIQUE (family_id, summary_year, major_category_id, minor_category_id, currency)
```

## 4. 业务规则

### 4.1 货币转换

- **基准货币**：CNY（人民币）
- **中间货币**：USD（美元）
- **固定汇率**：1 USD = 7 CNY
- **其他货币**：先查询汇率表转USD，再转CNY

### 4.2 数据完整性

- 大类可以新增、编辑、停用
- 子分类有关联记录时不能删除，只能停用
- 收入记录删除时不影响分类
- 汇总数据可以随时刷新重新计算

### 4.3 计算规则

- **大类汇总**：同一大类下所有子分类的收入总和
- **总计**：所有大类收入的总和（major_category_id = 0）
- **货币转换**：All模式下统一转换为USD进行统计

## 5. 权限要求

### 5.1 家庭成员权限

- 查看本家庭的所有收入记录
- 创建、修改本家庭的收入记录
- 查看所有分析报表
- 刷新年度汇总数据

### 5.2 管理员权限

- 管理大类和子分类
- 管理所有家庭的数据
- 执行系统维护任务

## 6. 性能要求

### 6.1 响应时间

- 列表查询：< 500ms
- 批量保存：< 2s
- 年度分析：< 3s
- 报表生成：< 5s
- 汇总刷新：< 10s

### 6.2 并发处理

- 支持多用户同时录入
- 同一记录的并发更新：后提交覆盖

## 7. 用户界面要求

### 7.1 响应式设计

- 支持桌面端（1920x1080以上）
- 支持移动端（375px以上）
- 自适应布局，优化触摸操作

### 7.2 交互体验

- 表格内输入框自动聚焦
- 支持Tab键快速切换
- 实时计算统计数据
- 友好的错误提示
- 刷新按钮带加载状态

### 7.3 数据可视化

- 饼图：大类占比
- 柱状图：月度趋势
- 表格：明细数据展示

## 8. 数据导入导出

### 8.1 导入

- 支持Excel格式导入历史数据
- 自动匹配分类
- 重复数据处理策略

### 8.2 导出

- 支持导出Excel格式
- 导出PDF报表
- 自定义导出字段

## 9. 未来扩展

### 9.1 智能分析

- 收入趋势预测
- 异常收入提醒
- 收入来源多样化分析

### 9.2 多维度分析

- 按成员分析
- 同期对比分析
- 与支出关联分析

### 9.3 第三方集成

- 银行流水导入
- 工资单识别
- 投资账户同步
