# 特殊支出追踪功能说明

## 功能概述

为了更好地区分常规支出和大额特殊支出，我们在年度支出汇总系统中增加了特殊支出追踪功能。

## 核心规则

**特殊支出定义**: 单笔支出 >= 10,000 USD（或其他货币折算后 >= 10,000 USD）

**计算公式**:
```
实际支出 = 基础支出 + 特殊支出 + 资产调整 + 负债调整
```

## 数据库变更

### 新增字段 (annual_expense_summary表)

1. **special_expense_amount** (DECIMAL(18,2))
   - 特殊支出总金额
   - 默认值: 0.00
   - 单位: USD

2. **special_expense_details** (JSON)
   - 特殊支出详情
   - 存储结构:
     ```json
     [
       {
         "minorCategoryId": 82,
         "minorCategoryName": "学费",
         "amount": 20345.00
       },
       {
         "minorCategoryId": 85,
         "minorCategoryName": "房产税",
         "amount": 23552.27
       }
     ]
     ```

### SQL脚本

- **database/add_special_expense_fields.sql**: 添加新字段的迁移脚本
- **database/03_stored_procedures.sql**: 更新后的存储过程（包含特殊支出逻辑）
- **database/recalculate_all_years.sql**: 重新计算所有年份的脚本

## 存储过程变更 (calculate_annual_expense_summary_v3)

### Part 1: 基础支出计算（修改）
- **排除规则**: 单笔 >= 10,000 USD 的支出不计入基础支出
- **使用年末汇率**: 每笔支出使用其所在年份的年末汇率进行折算

### Part 1.5: 特殊支出计算（新增）
1. 创建临时表存储小类级别的特殊支出
2. 查询所有 >= 10,000 USD 的支出记录
3. 按大类分组汇总
4. 构建JSON详情（包含所有小类信息）
5. 更新到annual_expense_summary表

### Part 2-3: 资产/负债调整（修改）
- 更新实际支出公式，包含special_expense_amount:
  ```sql
  actual_expense_amount = base_expense_amount
                        + COALESCE(special_expense_amount, 0)
                        + asset_adjustment
                        + liability_adjustment
  ```

### Part 4: 总计计算（修改）
- 在总计中汇总special_expense_amount
- 返回结果中增加"特殊支出"和"特殊支出详情"列

## 使用示例

### 查询2024年特殊支出明细

```sql
SELECT
    major_category_id,
    base_expense_amount,
    special_expense_amount,
    asset_adjustment,
    liability_adjustment,
    actual_expense_amount,
    special_expense_details
FROM annual_expense_summary
WHERE family_id = 1
  AND summary_year = 2024
  AND minor_category_id IS NULL
  AND special_expense_amount > 0;
```

### 执行年度汇总计算

```sql
CALL calculate_annual_expense_summary_v3(1, 2024);
```

## 实际案例分析

### 2024年特殊支出

| 大类 | 基础支出 | 特殊支出 | 特殊支出明细 |
|------|---------|---------|------------|
| 子女 | 20,279.95 | 20,345.00 | 学费 (20,345.00) |
| 住 | 56,762.42 | 23,552.27 | 房产税 (23,552.27) |
| **总计** | **142,315.57** | **43,897.27** | - |

**实际支出计算**:
- 子女: 20,279.95 + 20,345.00 = 40,624.95
- 住: 56,762.42 + 23,552.27 - 29,688.65 (负债调整) = 50,626.04
- 总计: 142,315.57 + 43,897.27 + 740.00 (资产调整) - 29,688.65 (负债调整) = 155,784.19

### 2018年特殊支出

| 大类 | 基础支出 | 特殊支出 | 特殊支出明细 |
|------|---------|---------|------------|
| 住 | 68,375.68 | 628,840.92 | 首付 (628,840.92) |
| **总计** | **137,818.81** | **628,840.92** | - |

这笔特殊支出是2018年房屋购买的首付款。

## 历史数据汇总

| 年份 | 基础支出 | 特殊支出 | 资产调整 | 负债调整 | 实际支出 |
|------|---------|---------|---------|---------|---------|
| 2017 | 139,284.71 | 10,000.00 | 2,828.28 | -1,569.02 | 148,025.45 |
| 2018 | 137,818.81 | 628,840.92 | 565.40 | -614,500.00 | 151,594.33 |
| 2019 | 147,060.93 | 47,031.68 | 1,330.00 | 1,100.00 | 191,662.61 |
| 2020 | 128,001.81 | 50,043.14 | 2,870.00 | 10,900.00 | 164,274.95 |
| 2021 | 130,625.59 | 46,993.80 | 260.00 | 38,460.00 | 138,899.39 |
| 2022 | 136,214.76 | 56,356.18 | -110.00 | 35,240.00 | 157,440.94 |
| 2023 | 130,317.51 | 35,674.05 | 880.00 | 31,271.00 | 133,840.56 |
| 2024 | 142,315.57 | 43,897.27 | 740.00 | 29,688.65 | 155,784.19 |
| 2025 | 143,861.33 | 54,372.56 | 54,242.71 | 28,359.72 | 115,631.46 |

## 优势与意义

1. **支出分类清晰**: 将常规支出和大额特殊支出分开统计
2. **数据透明**: 通过JSON详情可以追溯每笔特殊支出的来源
3. **分析准确**: 避免大额支出干扰常规支出趋势分析
4. **多笔支持**: 同一大类下的多笔特殊支出都会被列出

## 注意事项

1. 特殊支出阈值固定为10,000 USD
2. 使用年末汇率进行货币转换
3. 特殊支出不影响基础支出的计算
4. 资产/负债调整依然按原逻辑执行

## 生成时间
2025-12-17
