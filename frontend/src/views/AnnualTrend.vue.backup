<template>
  <div class="p-6 space-y-6">
    <!-- 页面标题和控制栏 -->
    <div class="bg-white rounded-lg shadow p-4">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold text-gray-900">年度趋势分析</h1>
        <div class="flex items-center gap-4">
          <!-- 家庭选择 -->
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-700">选择家庭：</label>
            <select v-model.number="familyId" @change="onFamilyChange"
                    class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm min-w-[180px]">
              <option v-for="family in families" :key="family.id" :value="family.id">
                {{ family.familyName }}
              </option>
            </select>
          </div>

          <!-- 年份选择 -->
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-700">显示年数：</label>
            <select v-model.number="displayYears" @change="fetchData"
                    class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm">
              <option :value="3">最近3年</option>
              <option :value="5">最近5年</option>
              <option :value="10">最近10年</option>
              <option :value="999">全部</option>
            </select>
          </div>

          <button @click="calculateSummary"
                  class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 text-sm font-medium">
            刷新数据
          </button>
        </div>
      </div>
    </div>

    <!-- 加载状态 -->
    <div v-if="loading" class="bg-white rounded-lg shadow p-12">
      <div class="flex flex-col items-center justify-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
        <p class="text-gray-600 mt-4">加载中...</p>
      </div>
    </div>

    <!-- Tab 切换 -->
    <div v-else-if="summaries.length > 0">
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-4" aria-label="Tabs">
          <button
            v-for="tab in tabs"
            :key="tab.key"
            @click="activeTab = tab.key"
            :class="[
              'whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm transition-colors',
              activeTab === tab.key
                ? 'border-primary text-primary'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
          >
            {{ tab.label }}
          </button>
        </nav>
      </div>

      <!-- 综合趋势 -->
      <div v-if="activeTab === 'overall'" class="bg-white rounded-lg shadow p-6 mt-6">
        <div class="mb-4">
          <h2 class="text-lg font-semibold text-gray-900">综合趋势</h2>
          <p class="text-sm text-gray-500 mt-1">资产、负债、净资产年度变化趋势</p>
        </div>
        <div class="h-96">
          <canvas ref="comprehensiveChartCanvas"></canvas>
        </div>
      </div>

      <!-- 净资产趋势 -->
      <div v-if="activeTab === 'networth'" class="bg-white rounded-lg shadow p-6 mt-6">
        <div class="mb-4">
          <h2 class="text-lg font-semibold text-gray-900">净资产趋势</h2>
          <p class="text-sm text-gray-500 mt-1">净资产年度变化及同比增长率</p>
        </div>
        <div class="h-80">
          <canvas ref="netWorthChartCanvas"></canvas>
        </div>
      </div>

      <!-- 资产趋势 -->
      <div v-if="activeTab === 'asset'" class="bg-white rounded-lg shadow p-6 mt-6">
        <div class="mb-4">
          <h2 class="text-lg font-semibold text-gray-900">资产趋势</h2>
          <p class="text-sm text-gray-500 mt-1">总资产年度变化及同比增长率</p>
        </div>
        <div class="h-80">
          <canvas ref="assetChartCanvas"></canvas>
        </div>
      </div>

      <!-- 汇总表格 -->
      <div v-if="activeTab === 'table'" class="bg-white rounded-lg shadow p-6 mt-6">
        <div class="mb-4">
          <h2 class="text-lg font-semibold text-gray-900">年度汇总表</h2>
          <p class="text-sm text-gray-500 mt-1">各年度财务数据对比</p>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">年份</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">总资产</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">资产同比</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">总负债</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">负债同比</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">净资产</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">净资产同比</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">摘要日期</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr v-for="summary in summaries" :key="summary.year" class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">{{ summary.year }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                  <div class="text-sm font-medium text-gray-900">${{ formatAmount(summary.totalAssets) }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                  <div v-if="summary.yoyAssetChange !== null" class="text-sm">
                    <div :class="getChangeColor(summary.yoyAssetChange)" class="font-medium">
                      {{ formatChange(summary.yoyAssetChange) }}
                    </div>
                    <div :class="getChangeColor(summary.yoyAssetChangePct)" class="text-xs">
                      ({{ formatPercent(summary.yoyAssetChangePct) }})
                    </div>
                  </div>
                  <div v-else class="text-sm text-gray-400">-</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                  <div class="text-sm font-medium text-gray-900">${{ formatAmount(summary.totalLiabilities) }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                  <div v-if="summary.yoyLiabilityChange !== null" class="text-sm">
                    <div :class="getChangeColor(summary.yoyLiabilityChange, true)" class="font-medium">
                      {{ formatChange(summary.yoyLiabilityChange) }}
                    </div>
                    <div :class="getChangeColor(summary.yoyLiabilityChangePct, true)" class="text-xs">
                      ({{ formatPercent(summary.yoyLiabilityChangePct) }})
                    </div>
                  </div>
                  <div v-else class="text-sm text-gray-400">-</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                  <div class="text-sm font-bold text-blue-600">${{ formatAmount(summary.netWorth) }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                  <div v-if="summary.yoyNetWorthChange !== null" class="text-sm">
                    <div :class="getChangeColor(summary.yoyNetWorthChange)" class="font-medium">
                      {{ formatChange(summary.yoyNetWorthChange) }}
                    </div>
                    <div :class="getChangeColor(summary.yoyNetWorthChangePct)" class="text-xs">
                      ({{ formatPercent(summary.yoyNetWorthChangePct) }})
                    </div>
                  </div>
                  <div v-else class="text-sm text-gray-400">基准年</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                  <div class="text-sm text-gray-600">{{ summary.summaryDate }}</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div> <!-- End of tab content container -->

    <!-- 无数据提示 -->
    <div v-else>
      <!-- 家庭选择（无数据时） -->
      <div class="bg-white rounded-lg shadow border border-gray-200 p-4">
        <div class="flex items-center gap-3">
          <label class="text-sm font-medium text-gray-700">家庭：</label>
          <select v-model.number="familyId" @change="onFamilyChange"
                  class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[200px]">
            <option v-for="family in families" :key="family.id" :value="family.id">
              {{ family.familyName }}
            </option>
          </select>
        </div>
      </div>

      <!-- 无数据提示 -->
      <div class="bg-white rounded-lg shadow border border-gray-200 p-12 text-center">
        <div class="text-gray-400 mb-2">
          <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">暂无年度数据</h3>
        <p class="text-gray-600 mb-4">请先添加资产和负债记录，然后计算年度汇总</p>
        <button @click="calculateSummary"
                class="px-6 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition">
          计算年度汇总
        </button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, nextTick, watch } from 'vue'
import { Chart, registerables } from 'chart.js'
import annualSummaryAPI from '@/api/annualSummary'
import familyAPI from '@/api/family'

Chart.register(...registerables)

// 数据
const summaries = ref([])
const families = ref([])
const loading = ref(false)
const displayYears = ref(5)
const familyId = ref(null)
const activeTab = ref('overall')

// Tabs 配置
const tabs = [
  { key: 'overall', label: '综合趋势' },
  { key: 'networth', label: '净资产趋势' },
  { key: 'asset', label: '资产趋势' },
  { key: 'table', label: '汇总表格' }
]

// 图表引用
const comprehensiveChartCanvas = ref(null)
const netWorthChartCanvas = ref(null)
const assetChartCanvas = ref(null)

// 图表实例
let comprehensiveChart = null
let netWorthChart = null
let assetChart = null

// 获取家庭列表
const fetchFamilies = async () => {
  try {
    const response = await familyAPI.getAll()
    families.value = response.data

    // 如果还没有选择家庭，默认选择第一个
    if (!familyId.value && families.value.length > 0) {
      familyId.value = families.value[0].id
    }
  } catch (error) {
    console.error('获取家庭列表失败:', error)
  }
}

// 家庭切换事件
const onFamilyChange = () => {
  fetchData()
}

// 获取数据
const fetchData = async () => {
  if (!familyId.value) return

  loading.value = true
  try {
    const response = await annualSummaryAPI.getRecent(familyId.value, displayYears.value)
    summaries.value = response.data.sort((a, b) => b.year - a.year)

    await nextTick()
    renderCharts()
  } catch (error) {
    console.error('获取年度汇总数据失败:', error)
  } finally {
    loading.value = false
  }
}

// 计算年度汇总
const calculateSummary = async () => {
  loading.value = true
  try {
    // 获取所有年份
    const allSummaries = await annualSummaryAPI.getAll(familyId.value)
    const years = allSummaries.data.map(s => s.year)

    // 如果没有数据，计算当前年份
    if (years.length === 0) {
      const currentYear = new Date().getFullYear()
      await annualSummaryAPI.calculate(familyId.value, currentYear)
    } else {
      // 批量刷新所有年份
      await annualSummaryAPI.batchCalculate(familyId.value, years)
    }

    await fetchData()
  } catch (error) {
    console.error('计算年度汇总失败:', error)
    alert('计算失败，请稍后重试')
  } finally {
    loading.value = false
  }
}

// 渲染图表
const renderCharts = () => {
  if (summaries.value.length === 0) return

  const sortedData = [...summaries.value].reverse() // 从旧到新排序
  const years = sortedData.map(s => s.year)
  const assets = sortedData.map(s => s.totalAssets)
  const liabilities = sortedData.map(s => s.totalLiabilities)
  const netWorths = sortedData.map(s => s.netWorth)
  const assetGrowths = sortedData.map(s => s.yoyAssetChangePct || 0)
  const netWorthGrowths = sortedData.map(s => s.yoyNetWorthChangePct || 0)

  // 综合趋势图
  if (comprehensiveChart) comprehensiveChart.destroy()
  if (comprehensiveChartCanvas.value) {
    comprehensiveChart = new Chart(comprehensiveChartCanvas.value, {
      type: 'line',
      data: {
        labels: years,
        datasets: [
          {
            label: '总资产',
            data: assets,
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true,
            tension: 0.4
          },
          {
            label: '总负债',
            data: liabilities,
            borderColor: 'rgb(239, 68, 68)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            fill: true,
            tension: 0.4
          },
          {
            label: '净资产',
            data: netWorths,
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': $' + formatAmount(context.parsed.y)
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '$' + formatAmountShort(value)
              }
            }
          }
        }
      }
    })
  }

  // 净资产趋势图（双Y轴）
  if (netWorthChart) netWorthChart.destroy()
  if (netWorthChartCanvas.value) {
    netWorthChart = new Chart(netWorthChartCanvas.value, {
      type: 'bar',
      data: {
        labels: years,
        datasets: [
          {
            label: '净资产',
            data: netWorths,
            backgroundColor: 'rgba(59, 130, 246, 0.7)',
            borderColor: 'rgb(59, 130, 246)',
            borderWidth: 1,
            yAxisID: 'y'
          },
          {
            label: '同比增长率',
            data: netWorthGrowths,
            type: 'line',
            borderColor: 'rgb(234, 88, 12)',
            backgroundColor: 'rgba(234, 88, 12, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                if (context.dataset.label === '净资产') {
                  return context.dataset.label + ': $' + formatAmount(context.parsed.y)
                } else {
                  return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%'
                }
              }
            }
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '$' + formatAmountShort(value)
              }
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
              drawOnChartArea: false,
            },
            ticks: {
              callback: function(value) {
                return value.toFixed(1) + '%'
              }
            }
          }
        }
      }
    })
  }

  // 资产趋势图（双Y轴）
  if (assetChart) assetChart.destroy()
  if (assetChartCanvas.value) {
    assetChart = new Chart(assetChartCanvas.value, {
      type: 'bar',
      data: {
        labels: years,
        datasets: [
          {
            label: '总资产',
            data: assets,
            backgroundColor: 'rgba(34, 197, 94, 0.7)',
            borderColor: 'rgb(34, 197, 94)',
            borderWidth: 1,
            yAxisID: 'y'
          },
          {
            label: '同比增长率',
            data: assetGrowths,
            type: 'line',
            borderColor: 'rgb(234, 88, 12)',
            backgroundColor: 'rgba(234, 88, 12, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                if (context.dataset.label === '总资产') {
                  return context.dataset.label + ': $' + formatAmount(context.parsed.y)
                } else {
                  return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%'
                }
              }
            }
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '$' + formatAmountShort(value)
              }
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
              drawOnChartArea: false,
            },
            ticks: {
              callback: function(value) {
                return value.toFixed(1) + '%'
              }
            }
          }
        }
      }
    })
  }
}

// 格式化金额
const formatAmount = (amount) => {
  if (!amount && amount !== 0) return '0.00'
  return Number(amount).toLocaleString('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  })
}

// 格式化金额（简短）
const formatAmountShort = (amount) => {
  if (amount >= 1000000) {
    return (amount / 1000000).toFixed(1) + 'M'
  } else if (amount >= 1000) {
    return (amount / 1000).toFixed(1) + 'K'
  }
  return amount.toFixed(0)
}

// 格式化变化金额
const formatChange = (amount) => {
  if (!amount && amount !== 0) return '-'
  const prefix = amount > 0 ? '+' : ''
  return prefix + '$' + formatAmount(Math.abs(amount))
}

// 格式化百分比
const formatPercent = (percent) => {
  if (!percent && percent !== 0) return '-'
  const prefix = percent > 0 ? '+' : ''
  return prefix + Number(percent).toFixed(2) + '%'
}

// 获取变化颜色
const getChangeColor = (value, isLiability = false) => {
  if (!value && value !== 0) return 'text-gray-400'

  // 对于负债，减少是好的（绿色），增加是不好的（红色）
  if (isLiability) {
    return value > 0 ? 'text-red-600' : 'text-green-600'
  }

  // 对于资产和净资产，增加是好的（绿色），减少是不好的（红色）
  return value > 0 ? 'text-green-600' : 'text-red-600'
}

// 监听 activeTab 变化，重新渲染图表
watch(activeTab, async () => {
  await nextTick()
  renderCharts()
})

// 组件挂载时获取数据
onMounted(async () => {
  await fetchFamilies()
  await fetchData()
})
</script>

<style scoped>
/* 表格样式 */
table {
  border-collapse: separate;
  border-spacing: 0;
}

table th {
  position: sticky;
  top: 0;
  background-color: #f9fafb;
  z-index: 10;
}
</style>
