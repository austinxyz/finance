-- ================================================================
-- 支出管理模块 - 更新约束
-- 版本: v1.1
-- 日期: 2025-12-10
-- 说明: 修改支出记录约束和字段
-- ================================================================

-- ----------------------------------------------------------------
-- 1. 修改user_id字段为可空（支出记录不强制关联用户）
-- ----------------------------------------------------------------
ALTER TABLE expense_records
  MODIFY COLUMN user_id BIGINT NULL COMMENT '记录人ID（可选）';

-- ----------------------------------------------------------------
-- 2. 删除旧的唯一约束（不包含currency）
-- ----------------------------------------------------------------
ALTER TABLE expense_records
  DROP INDEX uk_period_category;

-- ----------------------------------------------------------------
-- 3. 添加新的唯一约束（包含currency）
-- 约束：同一家庭、同一期间、同一子分类、同一货币只能有一条记录
-- ----------------------------------------------------------------
ALTER TABLE expense_records
  ADD UNIQUE KEY uk_family_period_category_currency (family_id, expense_period, minor_category_id, currency);

-- ================================================================
-- 说明：
-- 1. 支出记录基于家庭维度，不强制关联到具体用户
-- 2. 支持同一期间同一分类记录多种货币（如既有CNY记录又有USD记录）
-- 3. 唯一约束确保: family + period + category + currency = 唯一记录
-- ================================================================
