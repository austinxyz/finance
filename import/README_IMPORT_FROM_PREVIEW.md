# 从预览Excel导入数据使用说明

## 概述

`import_from_preview.py` 是一个智能导入工具，可以直接从预览Excel文件（`preview_{year}.xlsx`）导入数据到数据库，并且会自动检查数据库中是否已存在相同记录，避免重复导入。

## 核心功能

1. ✅ **直接从预览Excel导入**：无需单独的JSON文件
2. ✅ **智能去重**：自动检测已存在的记录，只导入新记录
3. ✅ **安全检查模式**：dry-run模式可以先检查不实际导入
4. ✅ **灵活选择**：可以指定只导入某些sheets
5. ✅ **详细统计**：显示每个sheet的检查和导入结果

## 重复检测逻辑

通过以下字段组合判断记录是否已存在：
- `family_id` - 家庭ID
- `expense_year` - 年份
- `expense_month` - 月份
- `expense_period` - 期间
- `minor_category_id` - 小分类ID
- `expense_type` - 记录类型（ACTUAL/BUDGET）

如果数据库中已存在完全匹配这些字段的记录，则跳过导入。

## 使用方法

### 1. 安全检查（推荐第一步）

先用dry-run模式检查哪些记录会被导入：

```bash
python3 import_from_preview.py --file preview_2024.xlsx --dry-run
```

输出示例：
```
================================================================================
📊 导入总结
================================================================================

处理的Sheets:

  🔍 2024-expense-USD
     总记录: 108
     已存在: 91
     新记录: 17
     已导入: 0

  ⊝ 2024-expense-CNY
     总记录: 25
     已存在: 25
     新记录: 0
     已导入: 0

总计:
  📋 处理sheets: 4
  📝 总记录数: 637
  ⊝ 已存在: 116 (跳过)
  ✨ 新记录: 521
```

### 2. 执行导入

确认检查结果无误后，去掉 `--dry-run` 参数执行实际导入：

```bash
python3 import_from_preview.py --file preview_2024.xlsx
```

### 3. 选择性导入

只导入特定的sheets：

```bash
# 只导入费用数据，不导入预算
python3 import_from_preview.py --file preview_2024.xlsx --sheets "2024-expense-USD,2024-expense-CNY"

# 只导入USD的数据
python3 import_from_preview.py --file preview_2024.xlsx --sheets "2024-expense-USD,2024-budgets-USD"
```

## 预算数据处理

预算数据的特殊处理：
- Excel中的预算是**年度总预算**
- 导入时会**自动分摊到12个月**（每月金额 = 年度预算 / 12）
- 每条预算记录会生成12条月度预算记录

例如：
- Excel中的"租房还贷"年度预算：41,000 USD
- 导入后生成12条记录，每月：3,416.67 USD

## 工作流程

### 完整流程

```bash
# 步骤1: 生成预览Excel
python3 import_all_preview.py --year 2024

# 步骤2: 检查预览数据
open preview_2024.xlsx

# 步骤3: 安全检查（dry-run）
python3 import_from_preview.py --file preview_2024.xlsx --dry-run

# 步骤4: 确认无误后执行导入
python3 import_from_preview.py --file preview_2024.xlsx
```

### 快速导入（跳过安全检查）

如果对数据很有信心：

```bash
# 直接导入，跳过dry-run
python3 import_from_preview.py --file preview_2024.xlsx
```

脚本会自动跳过已存在的记录，所以多次运行是安全的。

## 导入结果状态说明

| 图标 | 状态 | 说明 |
|------|------|------|
| ✅ | success | 成功导入新记录 |
| ⊝ | skipped | 所有记录已存在，跳过导入 |
| 🔍 | dry-run | 检查模式，未实际导入 |
| ❌ | failed | 导入失败 |

## 数据库配置

脚本会自动从 `backend/.env` 加载数据库配置：
- `DB_URL` - 数据库连接URL
- `DB_USERNAME` - 数据库用户名
- `DB_PASSWORD` - 数据库密码

确保该文件存在且配置正确。

## 依赖要求

需要安装以下Python包：
```bash
pip install pandas openpyxl
```

需要MySQL客户端：
```bash
brew install mysql-client
```

## 常见问题

### Q: 如何确认记录是否已导入？

A: 使用dry-run模式检查：
```bash
python3 import_from_preview.py --file preview_2024.xlsx --dry-run
```

### Q: 重复运行会导致数据重复吗？

A: 不会。脚本会自动检测已存在的记录并跳过。

### Q: 能否撤销导入？

A: 脚本不提供撤销功能。建议先使用dry-run模式确认，或在导入前备份数据库。

### Q: 导入失败怎么办？

A: 检查：
1. 数据库连接配置是否正确（`backend/.env`）
2. 数据库服务是否运行
3. 是否有足够的权限
4. Excel文件中的数据格式是否正确

### Q: 预算数据为什么变成了264条记录？

A: 预算数据是年度数据，脚本会自动为每个月创建一条记录。22条预算 × 12个月 = 264条月度预算记录。

## 示例输出

### Dry-Run模式

```
================================================================================
📊 从预览Excel文件导入数据
================================================================================
文件: preview_2024.xlsx
模式: 🔍 检查模式（不会实际导入）

✅ 数据库配置加载成功
   主机: 10.0.0.7:37719
   数据库: finance
✅ Excel文件读取成功
   包含sheets: 4

================================================================================
📄 处理Sheet: 2024-expense-USD
================================================================================
✅ Sheet读取成功: 108 条记录

🔍 检查费用记录是否已存在...

📊 检查结果:
   总记录数: 108
   已存在: 91 条 (将跳过)
   新记录: 17 条 (将导入)

🔍 检查模式: 跳过实际导入
```

### 实际导入模式

```
================================================================================
📄 处理Sheet: 2024-expense-USD
================================================================================
✅ Sheet读取成功: 108 条记录

🔍 检查费用记录是否已存在...

📊 检查结果:
   总记录数: 108
   已存在: 91 条 (将跳过)
   新记录: 17 条 (将导入)

📝 生成SQL语句...

🚀 开始导入 17 条新记录...
✅ 导入成功！

================================================================================
📊 导入总结
================================================================================
✅ 导入完成！
```

## 与传统导入方式的对比

### 传统方式

```bash
# 1. 生成JSON预览
python3 import_expenses.py preview --file 2024.xlsx --sheet "2024总帐 (US)" --family 1 --year 2024 --currency USD

# 2. 检查JSON文件
cat preview_2024_USD.json

# 3. 执行导入
python3 import_expenses.py import --preview-file preview_2024_USD.json

# 重复3次以上...
```

### 新方式

```bash
# 1. 生成整合预览Excel
python3 import_all_preview.py --year 2024

# 2. 检查预览Excel
open preview_2024.xlsx

# 3. 一键导入（带去重）
python3 import_from_preview.py --file preview_2024.xlsx
```

## 优势

1. ✅ **简化流程**：从多步简化为一键导入
2. ✅ **智能去重**：自动跳过已存在的记录
3. ✅ **安全性高**：dry-run模式 + 去重检测
4. ✅ **整合导入**：一次导入所有数据（费用+预算，USD+CNY）
5. ✅ **透明统计**：清晰显示每个sheet的导入情况
6. ✅ **幂等操作**：多次运行不会产生重复数据
